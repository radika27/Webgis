<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebGIS Interaktif</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            display: grid;
            grid-template-columns: 350px 1fr;
            grid-template-rows: 60px 1fr;
            height: 100vh;
            gap: 10px;
            padding: 10px;
        }

        .header {
            grid-column: 1 / -1;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
        }

        .header-left {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .header h1 {
            color: #2563eb;
            font-size: 24px;
            font-weight: 700;
            margin: 0;
        }

        .creator-info {
            margin-top: 2px;
        }

        .creator-info a {
            transition: all 0.3s ease;
        }

        .creator-info a:hover {
            color: #1d4ed8 !important;
            text-decoration: underline !important;
        }

        .search-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-box {
            padding: 8px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 25px;
            outline: none;
            transition: all 0.3s ease;
            width: 250px;
        }

        .search-box:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .search-btn {
            background: #2563eb;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .search-btn:hover {
            background: #1d4ed8;
            transform: translateY(-1px);
        }

        .sidebar {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .tab-container {
            display: flex;
            background: #f8fafc;
            border-radius: 12px 12px 0 0;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: transparent;
            font-weight: 600;
            color: #64748b;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: white;
            color: #2563eb;
            border-bottom: 3px solid #2563eb;
        }

        .tab-content {
            padding: 20px;
            flex: 1;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #374151;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            outline: none;
            transition: all 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .btn {
            background: #2563eb;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 10px;
        }

        .btn:hover {
            background: #1d4ed8;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
        }

        .btn-secondary {
            background: #6b7280;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .file-input {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

        .file-input input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            background: #f3f4f6;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-input-label:hover {
            background: #e5e7eb;
            border-color: #2563eb;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: 700;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .data-table th, .data-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
            font-size: 12px;
        }

        .data-table th {
            background: #f8fafc;
            font-weight: 600;
            cursor: pointer;
        }

        .data-table th:hover {
            background: #e2e8f0;
        }

        .filter-section {
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .filter-section h4 {
            margin-bottom: 10px;
            color: #374151;
        }

        .chart-container {
            height: 200px;
            margin: 15px 0;
        }

        .map-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow: hidden;
            position: relative;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .basemap-control {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            padding: 5px;
        }

        .basemap-control select {
            border: none;
            outline: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            color: #374151;
            cursor: pointer;
        }

        .basemap-control select:hover {
            background: #f3f4f6;
        }

        .custom-popup {
            font-family: inherit;
        }

        .popup-title {
            font-weight: 700;
            color: #2563eb;
            margin-bottom: 8px;
        }

        .popup-content {
            font-size: 14px;
            line-height: 1.5;
        }

        .popup-category {
            background: #2563eb;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            display: inline-block;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                grid-template-rows: 60px 300px 1fr;
            }
            
            .search-box {
                width: 150px;
            }
            
            .header h1 {
                font-size: 18px;
            }
            
            .creator-info {
                display: none;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #6b7280;
        }

        .success-message {
            background: #10b981;
            color: white;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
        }

        .error-message {
            background: #ef4444;
            color: white;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
        }

        .photo-upload-container {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .photo-upload-container:hover {
            border-color: #2563eb;
            background: #f8fafc;
        }

        .photo-upload-area {
            cursor: pointer;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .photo-upload-area:hover {
            background: #f3f4f6;
            border-radius: 6px;
        }

        .photo-preview {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .photo-item {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #e5e7eb;
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-remove {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .photo-remove:hover {
            background: #dc2626;
        }

        .popup-photos {
            display: flex;
            gap: 5px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .popup-photo {
            width: 60px;
            height: 60px;
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
            border: 1px solid #e5e7eb;
        }

        .popup-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
        }

        .photo-modal img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 8px;
        }

        .photo-modal-close {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 30px;
            cursor: pointer;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
        }

        .modal-header h3 {
            margin: 0;
            color: #374151;
        }

        .modal-close {
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
        }

        .modal-close:hover {
            color: #374151;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .modal-actions .btn {
            width: auto;
            margin: 0;
            padding: 10px 20px;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .action-btn {
            background: none;
            border: none;
            padding: 5px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .action-btn.edit {
            color: #2563eb;
        }

        .action-btn.edit:hover {
            background: #dbeafe;
        }

        .action-btn.delete {
            color: #ef4444;
        }

        .action-btn.delete:hover {
            background: #fee2e2;
        }

        .column-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8fafc;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .column-info {
            flex: 1;
        }

        .column-name {
            font-weight: 600;
            color: #374151;
        }

        .column-type {
            font-size: 12px;
            color: #6b7280;
        }

        .delete-column-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }

        .delete-column-btn:hover {
            background: #dc2626;
        }

        .data-tab-panel {
            display: block;
        }

        .coordinate-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 10px;
            background: #f8fafc;
            border-radius: 4px;
            margin-bottom: 5px;
            font-size: 12px;
        }

        .coordinate-remove {
            background: #ef4444;
            color: white;
            border: none;
            padding: 2px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
        }

        .coordinate-remove:hover {
            background: #dc2626;
        }

        .line-drawing {
            cursor: crosshair !important;
        }

        .temp-line {
            stroke-dasharray: 5, 5;
            animation: dash 1s linear infinite;
        }

        @keyframes dash {
            to {
                stroke-dashoffset: -10;
            }
        }

        .click-indicator {
            position: absolute;
            width: 40px;
            height: 40px;
            border: 3px solid #2563eb;
            border-radius: 50%;
            background: rgba(37, 99, 235, 0.2);
            pointer-events: none;
            z-index: 1000;
            animation: clickPulse 1s ease-out;
            transform: translate(-50%, -50%);
        }

        @keyframes clickPulse {
            0% {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(1.5);
                opacity: 0;
            }
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            }
            50% {
                transform: scale(1.1);
                box-shadow: 0 4px 20px rgba(37, 99, 235, 0.5);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            }
        }

        .selected-marker {
            filter: drop-shadow(0 0 10px #2563eb) brightness(1.2);
            z-index: 1000 !important;
        }

        .selected-line {
            filter: drop-shadow(0 0 8px #2563eb);
        }

        .selected-polygon {
            filter: drop-shadow(0 0 8px #2563eb);
        }

        .location-selected-indicator {
            background: #e0f2fe;
            border: 2px solid #0277bd;
            border-radius: 6px;
            padding: 8px 12px;
            margin-bottom: 10px;
            font-weight: 600;
            color: #0277bd;
            display: none;
            align-items: center;
            gap: 8px;
        }

        .location-selected-indicator.show {
            display: flex;
        }

        .popup-field-item {
            display: flex;
            align-items: center;
            padding: 8px;
            background: #f8fafc;
            border-radius: 4px;
            margin-bottom: 5px;
        }

        .popup-field-item input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }

        .popup-field-item label {
            margin: 0;
            cursor: pointer;
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1><i class="fas fa-map-marked-alt"></i> WebGIS Interaktif</h1>
                <div class="creator-info">
                    <small style="color: #6b7280;">
                        Created by 
                        <a href="https://www.linkedin.com/in/radhyka-galih-pranata-b78249209" 
                           target="_blank" 
                           style="color: #2563eb; text-decoration: none; font-weight: 600;">
                            <i class="fab fa-linkedin"></i> Radhyka Galih Pranata
                        </a>
                    </small>
                </div>
            </div>
            <div class="search-container">
                <input type="text" class="search-box" id="searchInput" placeholder="Cari lokasi...">
                <button class="search-btn" onclick="searchLocation()">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>

        <div class="sidebar">
            <div class="tab-container">
                <button class="tab active" onclick="switchTab('input')">Input Point</button>
                <button class="tab" onclick="switchTab('line')">Input Line</button>
                <button class="tab" onclick="switchTab('polygon')">Input Polygon</button>
                <button class="tab" onclick="switchTab('dashboard')">Dashboard</button>
            </div>

            <div class="tab-content">
                <div id="input-panel" class="tab-panel active">
                    <div class="success-message" id="successMessage"></div>
                    <div class="error-message" id="errorMessage"></div>
                    
                    <h3 style="margin-bottom: 15px; color: #374151;">Tambah Data Manual</h3>
                    <form id="manualForm">
                        <div class="form-group">
                            <label>Nama Lokasi</label>
                            <input type="text" id="locationName" required>
                        </div>
                        <div class="form-group">
                            <label>Kategori</label>
                            <select id="category" required>
                                <option value="">Pilih Kategori</option>
                                <option value="Restoran">Restoran</option>
                                <option value="Hotel">Hotel</option>
                                <option value="Wisata">Wisata</option>
                                <option value="Rumah Sakit">Rumah Sakit</option>
                                <option value="Sekolah">Sekolah</option>
                                <option value="Lainnya">Lainnya</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Deskripsi</label>
                            <textarea id="description" rows="3"></textarea>
                        </div>
                        <div style="background: #f8fafc; padding: 10px; border-radius: 6px; margin-bottom: 15px;">
                            <small style="color: #6b7280;">
                                <i class="fas fa-info-circle"></i> 
                                Klik pada peta untuk menentukan lokasi point
                            </small>
                        </div>
                        <div class="location-selected-indicator" id="locationSelectedIndicator">
                            <i class="fas fa-map-marker-alt"></i>
                            <span id="selectedLocationText">Lokasi belum dipilih</span>
                        </div>
                        <div id="customFields"></div>
                        <div class="form-group">
                            <label>Foto Lokasi (Maksimal 2 foto)</label>
                            <div class="photo-upload-container">
                                <input type="file" id="photoInput" accept="image/*" multiple onchange="handlePhotoUpload(event)" style="display: none;">
                                <div class="photo-upload-area" onclick="document.getElementById('photoInput').click()">
                                    <i class="fas fa-camera" style="font-size: 24px; color: #6b7280; margin-bottom: 10px;"></i>
                                    <div>Klik untuk upload foto</div>
                                    <small style="color: #6b7280;">JPG, PNG - Maksimal 2 foto</small>
                                </div>
                                <div class="photo-preview" id="photoPreview"></div>
                            </div>
                        </div>
                        <button type="submit" class="btn">
                            <i class="fas fa-plus"></i> Tambah Lokasi
                        </button>
                    </form>

                    <hr style="margin: 20px 0; border: 1px solid #e5e7eb;">

                    <h3 style="margin-bottom: 15px; color: #374151;">Import File</h3>
                    <div class="file-input">
                        <input type="file" id="fileInput" accept=".json,.kml,.xlsx,.xls" onchange="handleFileUpload(event)">
                        <label for="fileInput" class="file-input-label">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 24px; color: #6b7280; margin-bottom: 10px;"></i>
                            <div>Klik untuk upload file JSON/KML/Excel</div>
                            <small style="color: #6b7280;">JSON, KML, XLSX, XLS - Maksimal 5MB</small>
                        </label>
                    </div>

                    <div class="loading" id="loading">
                        <i class="fas fa-spinner fa-spin"></i> Memproses file...
                    </div>
                    
                    <button class="btn btn-secondary" onclick="clearAllData()">
                        <i class="fas fa-trash"></i> Hapus Semua Data
                    </button>
                </div>

                <div id="line-panel" class="tab-panel">
                    <div class="success-message" id="lineSuccessMessage"></div>
                    <div class="error-message" id="lineErrorMessage"></div>
                    
                    <h3 style="margin-bottom: 15px; color: #374151;">Tambah Data Line</h3>
                    <form id="lineForm">
                        <div class="form-group">
                            <label>Nama Line</label>
                            <input type="text" id="lineName" required>
                        </div>
                        <div class="form-group">
                            <label>Kategori</label>
                            <select id="lineCategory" required>
                                <option value="">Pilih Kategori</option>
                                <option value="Jalan">Jalan</option>
                                <option value="Sungai">Sungai</option>
                                <option value="Jalur Transportasi">Jalur Transportasi</option>
                                <option value="Batas Wilayah">Batas Wilayah</option>
                                <option value="Lainnya">Lainnya</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Deskripsi</label>
                            <textarea id="lineDescription" rows="3"></textarea>
                        </div>
                        <div id="lineCustomFields"></div>
                        <div class="form-group">
                            <label>Koordinat Line (klik pada peta untuk menambah titik)</label>
                            <div style="background: #f8fafc; padding: 10px; border-radius: 6px; margin-bottom: 10px;">
                                <small style="color: #6b7280;">
                                    <i class="fas fa-info-circle"></i> 
                                    Klik pada peta untuk menambah titik line. Minimal 2 titik diperlukan.
                                </small>
                            </div>
                            <div id="lineLength" style="background: #e0f2fe; padding: 8px; border-radius: 4px; margin-bottom: 10px; font-weight: 600; color: #0277bd;">
                                <i class="fas fa-ruler"></i> Panjang: 0 meter
                            </div>
                            <div id="lineCoordinates" style="max-height: 150px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 6px; padding: 10px;">
                                <div id="coordinatesList"></div>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 10px;">
                                <button type="button" class="btn btn-secondary" onclick="clearLineCoordinates()" style="width: auto; padding: 8px 15px; margin: 0;">
                                    <i class="fas fa-trash"></i> Hapus Semua
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="undoLastPoint()" style="width: auto; padding: 8px 15px; margin: 0;">
                                    <i class="fas fa-undo"></i> Undo
                                </button>
                            </div>
                        </div>
                        <button type="submit" class="btn">
                            <i class="fas fa-plus"></i> Tambah Line
                        </button>
                    </form>

                    <hr style="margin: 20px 0; border: 1px solid #e5e7eb;">

                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="color: #374151; margin: 0;">Kelola Kolom Line</h4>
                        <button class="btn" style="width: auto; padding: 8px 15px; margin: 0;" onclick="openLineColumnManager()">
                            <i class="fas fa-columns"></i> Kelola Kolom
                        </button>
                    </div>

                    <button class="btn btn-secondary" onclick="clearAllLines()">
                        <i class="fas fa-trash"></i> Hapus Semua Line
                    </button>
                </div>

                <div id="polygon-panel" class="tab-panel">
                    <div class="success-message" id="polygonSuccessMessage"></div>
                    <div class="error-message" id="polygonErrorMessage"></div>
                    
                    <h3 style="margin-bottom: 15px; color: #374151;">Tambah Data Polygon</h3>
                    <form id="polygonForm">
                        <div class="form-group">
                            <label>Nama Polygon</label>
                            <input type="text" id="polygonName" required>
                        </div>
                        <div class="form-group">
                            <label>Kategori</label>
                            <select id="polygonCategory" required>
                                <option value="">Pilih Kategori</option>
                                <option value="Wilayah Administrasi">Wilayah Administrasi</option>
                                <option value="Kawasan Industri">Kawasan Industri</option>
                                <option value="Kawasan Pemukiman">Kawasan Pemukiman</option>
                                <option value="Taman/Hutan">Taman/Hutan</option>
                                <option value="Danau/Waduk">Danau/Waduk</option>
                                <option value="Lainnya">Lainnya</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Deskripsi</label>
                            <textarea id="polygonDescription" rows="3"></textarea>
                        </div>
                        <div id="polygonCustomFields"></div>
                        
                        <div class="form-group">
                            <label>Mode Gambar Polygon</label>
                            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                                <button type="button" class="btn" id="freeDrawBtn" onclick="setPolygonMode('free')" style="flex: 1; padding: 8px; margin: 0; background: #2563eb;">
                                    <i class="fas fa-draw-polygon"></i> Manual
                                </button>
                                <button type="button" class="btn btn-secondary" id="squareDrawBtn" onclick="setPolygonMode('square')" style="flex: 1; padding: 8px; margin: 0;">
                                    <i class="fas fa-square"></i> Persegi
                                </button>
                                <button type="button" class="btn btn-secondary" id="circleDrawBtn" onclick="setPolygonMode('circle')" style="flex: 1; padding: 8px; margin: 0;">
                                    <i class="fas fa-circle"></i> Lingkaran
                                </button>
                            </div>
                        </div>

                        <div id="circleRadiusControl" style="display: none; margin-bottom: 15px;">
                            <div class="form-group">
                                <label>Radius Lingkaran</label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <input type="range" id="circleRadiusSlider" min="50" max="5000" value="500" style="flex: 1;" oninput="updateCircleRadius()">
                                    <input type="number" id="circleRadiusInput" min="50" max="5000" value="500" style="width: 80px;" onchange="updateCircleRadiusFromInput()">
                                    <span style="font-size: 12px; color: #6b7280;">meter</span>
                                </div>
                                <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">
                                    Klik pada peta untuk menentukan pusat lingkaran
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label id="polygonInstructionLabel">Koordinat Polygon (klik pada peta untuk menambah titik)</label>
                            <div id="polygonInstructions" style="background: #f8fafc; padding: 10px; border-radius: 6px; margin-bottom: 10px;">
                                <small style="color: #6b7280;">
                                    <i class="fas fa-info-circle"></i> 
                                    <span id="polygonInstructionText">Klik pada peta untuk menambah titik polygon. Minimal 3 titik diperlukan. Polygon akan otomatis tertutup.</span>
                                </small>
                            </div>
                            <div id="polygonArea" style="background: #e8f5e8; padding: 8px; border-radius: 4px; margin-bottom: 10px; font-weight: 600; color: #2e7d32;">
                                <i class="fas fa-vector-square"></i> Luas Area: 0 mÂ²
                            </div>
                            <div id="polygonCoordinates" style="max-height: 150px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 6px; padding: 10px;">
                                <div id="polygonCoordinatesList"></div>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 10px;">
                                <button type="button" class="btn btn-secondary" onclick="clearPolygonCoordinates()" style="width: auto; padding: 8px 15px; margin: 0;">
                                    <i class="fas fa-trash"></i> Hapus Semua
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="undoLastPolygonPoint()" style="width: auto; padding: 8px 15px; margin: 0;">
                                    <i class="fas fa-undo"></i> Undo
                                </button>
                            </div>
                        </div>
                        <button type="submit" class="btn">
                            <i class="fas fa-plus"></i> Tambah Polygon
                        </button>
                    </form>

                    <hr style="margin: 20px 0; border: 1px solid #e5e7eb;">

                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="color: #374151; margin: 0;">Kelola Kolom Polygon</h4>
                        <button class="btn" style="width: auto; padding: 8px 15px; margin: 0;" onclick="openPolygonColumnManager()">
                            <i class="fas fa-columns"></i> Kelola Kolom
                        </button>
                    </div>

                    <button class="btn btn-secondary" onclick="clearAllPolygons()">
                        <i class="fas fa-trash"></i> Hapus Semua Polygon
                    </button>
                </div>

                <div id="dashboard-panel" class="tab-panel">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="totalLocations">0</div>
                            <div class="stat-label">Total Point</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalLines">0</div>
                            <div class="stat-label">Total Line</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalCategories">0</div>
                            <div class="stat-label">Kategori Point</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalPolygons">0</div>
                            <div class="stat-label">Total Polygon</div>
                        </div>
                    </div>

                    <div class="filter-section">
                        <h4>Filter Data</h4>
                        <div class="form-group">
                            <select id="categoryFilter" onchange="filterData()">
                                <option value="">Semua Kategori</option>
                            </select>
                        </div>
                    </div>

                    <div class="chart-container">
                        <canvas id="categoryChart"></canvas>
                    </div>

                    <div style="display: flex; gap: 10px; margin: 15px 0;">
                        <button class="btn" onclick="exportToKML()" style="background: #10b981; flex: 1;">
                            <i class="fas fa-download"></i> Export ke KML
                        </button>
                        <button class="btn" onclick="exportToKMZ()" style="background: #f59e0b; flex: 1;">
                            <i class="fas fa-file-archive"></i> Export ke KMZ
                        </button>
                    </div>

                    <div class="tab-container" style="margin: 15px 0;">
                        <button class="tab active" onclick="switchDataTab('points')">Data Point</button>
                        <button class="tab" onclick="switchDataTab('lines')">Data Line</button>
                        <button class="tab" onclick="switchDataTab('polygons')">Data Polygon</button>
                    </div>

                    <div id="points-data" class="data-tab-panel">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h4 style="color: #374151; margin: 0;">Data Point</h4>
                            <button class="btn" style="width: auto; padding: 8px 15px; margin: 0;" onclick="openColumnManager()">
                                <i class="fas fa-columns"></i> Kelola Kolom
                            </button>
                        </div>
                        <div style="max-height: 300px; overflow-y: auto;">
                            <table class="data-table" id="dataTable">
                                <thead id="tableHead">
                                    <tr>
                                        <th onclick="sortTable(0)">Nama <i class="fas fa-sort"></i></th>
                                        <th onclick="sortTable(1)">Kategori <i class="fas fa-sort"></i></th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="tableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="lines-data" class="data-tab-panel" style="display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h4 style="color: #374151; margin: 0;">Data Line</h4>
                            <button class="btn" style="width: auto; padding: 8px 15px; margin: 0;" onclick="openLineColumnManager()">
                                <i class="fas fa-columns"></i> Kelola Kolom
                            </button>
                        </div>
                        <div style="max-height: 300px; overflow-y: auto;">
                            <table class="data-table" id="lineDataTable">
                                <thead id="lineTableHead">
                                    <tr>
                                        <th onclick="sortLineTable(0)">Nama <i class="fas fa-sort"></i></th>
                                        <th onclick="sortLineTable(1)">Kategori <i class="fas fa-sort"></i></th>
                                        <th onclick="sortLineTable(2)">Panjang <i class="fas fa-sort"></i></th>
                                        <th onclick="sortLineTable(3)">Titik <i class="fas fa-sort"></i></th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="lineTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="polygons-data" class="data-tab-panel" style="display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h4 style="color: #374151; margin: 0;">Data Polygon</h4>
                            <button class="btn" style="width: auto; padding: 8px 15px; margin: 0;" onclick="openPolygonColumnManager()">
                                <i class="fas fa-columns"></i> Kelola Kolom
                            </button>
                        </div>
                        <div style="max-height: 300px; overflow-y: auto;">
                            <table class="data-table" id="polygonDataTable">
                                <thead id="polygonTableHead">
                                    <tr>
                                        <th onclick="sortPolygonTable(0)">Nama <i class="fas fa-sort"></i></th>
                                        <th onclick="sortPolygonTable(1)">Kategori <i class="fas fa-sort"></i></th>
                                        <th onclick="sortPolygonTable(2)">Luas Area <i class="fas fa-sort"></i></th>
                                        <th onclick="sortPolygonTable(3)">Titik <i class="fas fa-sort"></i></th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="polygonTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="map-container">
            <div class="basemap-control">
                <select id="basemapSelector" onchange="changeBasemap()">
                    <option value="osm">OpenStreetMap</option>
                    <option value="satellite">Satelit</option>
                    <option value="terrain">Terrain</option>
                    <option value="dark">Dark Mode</option>
                </select>
            </div>
            <div id="map"></div>
        </div>
    </div>

    <!-- Photo Modal -->
    <div class="photo-modal" id="photoModal" onclick="closePhotoModal()">
        <span class="photo-modal-close">&times;</span>
        <img id="modalPhoto" src="" alt="Photo">
    </div>

    <!-- Edit Location Modal -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Lokasi</h3>
                <span class="modal-close" onclick="closeEditModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <div class="form-group">
                        <label>Nama Lokasi</label>
                        <input type="text" id="editLocationName" required>
                    </div>
                    <div class="form-group">
                        <label>Latitude</label>
                        <input type="number" id="editLatitude" step="any" required>
                    </div>
                    <div class="form-group">
                        <label>Longitude</label>
                        <input type="number" id="editLongitude" step="any" required>
                    </div>
                    <div class="form-group">
                        <label>Kategori</label>
                        <select id="editCategory" required>
                            <option value="">Pilih Kategori</option>
                            <option value="Restoran">Restoran</option>
                            <option value="Hotel">Hotel</option>
                            <option value="Wisata">Wisata</option>
                            <option value="Rumah Sakit">Rumah Sakit</option>
                            <option value="Sekolah">Sekolah</option>
                            <option value="Lainnya">Lainnya</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Deskripsi</label>
                        <textarea id="editDescription" rows="3"></textarea>
                    </div>
                    <div id="editCustomFields"></div>
                    <div class="form-group">
                        <label>Foto Lokasi (Maksimal 2 foto)</label>
                        <div class="photo-upload-container">
                            <input type="file" id="editPhotoInput" accept="image/*" multiple onchange="handleEditPhotoUpload(event)" style="display: none;">
                            <div class="photo-upload-area" onclick="document.getElementById('editPhotoInput').click()">
                                <i class="fas fa-camera" style="font-size: 24px; color: #6b7280; margin-bottom: 10px;"></i>
                                <div>Klik untuk upload foto</div>
                                <small style="color: #6b7280;">JPG, PNG - Maksimal 2 foto</small>
                            </div>
                            <div class="photo-preview" id="editPhotoPreview"></div>
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Batal</button>
                        <button type="submit" class="btn">Simpan Perubahan</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Line Modal -->
    <div class="modal" id="editLineModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Line</h3>
                <span class="modal-close" onclick="closeEditLineModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="editLineForm">
                    <div class="form-group">
                        <label>Nama Line</label>
                        <input type="text" id="editLineName" required>
                    </div>
                    <div class="form-group">
                        <label>Kategori</label>
                        <select id="editLineCategory" required>
                            <option value="">Pilih Kategori</option>
                            <option value="Jalan">Jalan</option>
                            <option value="Sungai">Sungai</option>
                            <option value="Jalur Transportasi">Jalur Transportasi</option>
                            <option value="Batas Wilayah">Batas Wilayah</option>
                            <option value="Lainnya">Lainnya</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Deskripsi</label>
                        <textarea id="editLineDescription" rows="3"></textarea>
                    </div>
                    <div id="editLineCustomFields"></div>
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeEditLineModal()">Batal</button>
                        <button type="submit" class="btn">Simpan Perubahan</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Line Column Manager Modal -->
    <div class="modal" id="lineColumnModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Kelola Kolom Line</h3>
                <span class="modal-close" onclick="closeLineColumnModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Tambah Kolom Baru</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="newLineColumnName" placeholder="Nama kolom..." style="flex: 1;">
                        <select id="newLineColumnType" style="width: 120px;">
                            <option value="text">Teks</option>
                            <option value="number">Angka</option>
                            <option value="date">Tanggal</option>
                            <option value="select">Pilihan</option>
                        </select>
                        <button type="button" class="btn" style="width: auto; padding: 8px 15px; margin: 0;" onclick="addLineCustomColumn()">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
                <div id="lineSelectOptions" style="display: none; margin-top: 10px;">
                    <label>Opsi Pilihan (pisahkan dengan koma)</label>
                    <input type="text" id="lineSelectOptionsList" placeholder="Opsi 1, Opsi 2, Opsi 3...">
                </div>
                <div class="existing-columns">
                    <h4 style="margin: 20px 0 10px 0;">Kolom yang Ada</h4>
                    <div id="lineColumnsList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Polygon Column Manager Modal -->
    <div class="modal" id="polygonColumnModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Kelola Kolom Polygon</h3>
                <span class="modal-close" onclick="closePolygonColumnModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Tambah Kolom Baru</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="newPolygonColumnName" placeholder="Nama kolom..." style="flex: 1;">
                        <select id="newPolygonColumnType" style="width: 120px;">
                            <option value="text">Teks</option>
                            <option value="number">Angka</option>
                            <option value="date">Tanggal</option>
                            <option value="select">Pilihan</option>
                        </select>
                        <button type="button" class="btn" style="width: auto; padding: 8px 15px; margin: 0;" onclick="addPolygonCustomColumn()">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
                <div id="polygonSelectOptions" style="display: none; margin-top: 10px;">
                    <label>Opsi Pilihan (pisahkan dengan koma)</label>
                    <input type="text" id="polygonSelectOptionsList" placeholder="Opsi 1, Opsi 2, Opsi 3...">
                </div>
                <div class="existing-columns">
                    <h4 style="margin: 20px 0 10px 0;">Kolom yang Ada</h4>
                    <div id="polygonColumnsList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Column Manager Modal -->
    <div class="modal" id="columnModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Kelola Kolom</h3>
                <span class="modal-close" onclick="closeColumnModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Tambah Kolom Baru</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="newColumnName" placeholder="Nama kolom..." style="flex: 1;">
                        <select id="newColumnType" style="width: 120px;">
                            <option value="text">Teks</option>
                            <option value="number">Angka</option>
                            <option value="date">Tanggal</option>
                            <option value="select">Pilihan</option>
                        </select>
                        <button type="button" class="btn" style="width: auto; padding: 8px 15px; margin: 0;" onclick="addCustomColumn()">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
                <div id="selectOptions" style="display: none; margin-top: 10px;">
                    <label>Opsi Pilihan (pisahkan dengan koma)</label>
                    <input type="text" id="selectOptionsList" placeholder="Opsi 1, Opsi 2, Opsi 3...">
                </div>
                <div class="existing-columns">
                    <h4 style="margin: 20px 0 10px 0;">Kolom yang Ada</h4>
                    <div id="columnsList"></div>
                </div>
                <hr style="margin: 20px 0; border: 1px solid #e5e7eb;">
                <div class="popup-settings">
                    <h4 style="margin: 0 0 15px 0;">Pengaturan Popup</h4>
                    <div class="form-group">
                        <label>Kolom yang Ditampilkan di Popup</label>
                        <div id="popupFieldsList" style="max-height: 200px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 6px; padding: 10px;">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let map;
        let markers = [];
        let lines = [];
        let polygons = [];
        let locationData = [];
        let lineData = [];
        let polygonData = [];
        let chart;
        let selectedPhotos = [];
        let editPhotos = [];
        let customColumns = [];
        let lineColumns = [];
        let polygonColumns = [];
        let editingIndex = -1;
        let editingLineIndex = -1;
        let editingPolygonIndex = -1;
        let isDrawingLine = false;
        let isDrawingPolygon = false;
        let currentLineCoords = [];
        let currentPolygonCoords = [];
        let tempLine = null;
        let tempPolygon = null;
        let tempPointMarker = null;
        let polygonMode = 'free'; // 'free', 'square', 'circle'
        let circleRadius = 500; // default radius in meters
        let tempCircle = null;
        let isDrawingSquare = false;
        let squareStartPoint = null;
        let selectedMarker = null;
        let selectedLine = null;
        let selectedPolygon = null;
        let currentBasemap = null;
        let basemaps = {};
        let popupSettings = {
            showName: true,
            showCategory: true,
            showDescription: true,
            showCoordinates: false,
            showPhotos: true,
            customFields: []
        };

        // Initialize map
        function initMap() {
            map = L.map('map').setView([-7.304459698793576, 110.1768221744262], 7); // Middel Java, Indonesia            
            // Define basemap layers
            basemaps = {
                osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap contributors'
                }),
                satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'Â© Esri, Maxar, GeoEye, Earthstar Geographics, CNES/Airbus DS, USDA, USGS, AeroGRID, IGN, and the GIS User Community'
                }),
                terrain: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenTopoMap (CC-BY-SA)'
                }),
                dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    attribution: 'Â© OpenStreetMap contributors Â© CARTO'
                })
            };
            
            // Set default basemap
            currentBasemap = basemaps.satellite;
            currentBasemap.addTo(map);

            // Add click event to map for adding markers and line points
            map.on('click', function(e) {
                const activeTab = document.querySelector('.tab.active').textContent;
                
                // Show click indicator animation
                showClickIndicator(e.containerPoint);
                
                if (activeTab === 'Input Line') {
                    // Add point to line coordinates
                    currentLineCoords.push([e.latlng.lat, e.latlng.lng]);
                    updateCoordinatesList();
                    updateTempLine();
                } else if (activeTab === 'Input Polygon') {
                    handlePolygonClick(e);
                } else if (activeTab === 'Input Point') {
                    // Store coordinates for point input
                    window.selectedLat = e.latlng.lat;
                    window.selectedLng = e.latlng.lng;
                    
                    // Remove previous temp marker
                    if (tempPointMarker) {
                        map.removeLayer(tempPointMarker);
                    }
                    
                    // Add temporary marker to show selected location
                    tempPointMarker = L.marker([e.latlng.lat, e.latlng.lng], {
                        icon: L.divIcon({
                            html: `<div style="background-color: #2563eb; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 3px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.3); animation: pulse 2s infinite;"><i class="fas fa-map-marker-alt" style="color: white; font-size: 12px;"></i></div>`,
                            className: 'temp-point-marker',
                            iconSize: [30, 30],
                            iconAnchor: [15, 15]
                        })
                    }).addTo(map);
                    
                    // Update location indicator
                    updateLocationIndicator(e.latlng.lat, e.latlng.lng);
                    
                    // Show visual feedback
                    showMessage(`Lokasi dipilih: ${e.latlng.lat.toFixed(6)}, ${e.latlng.lng.toFixed(6)}`, 'success');
                }
            });
        }

        // Handle photo upload
        function handlePhotoUpload(event) {
            const files = Array.from(event.target.files);
            
            if (selectedPhotos.length + files.length > 2) {
                showMessage('Maksimal hanya 2 foto yang diperbolehkan!', 'error');
                return;
            }
            
            files.forEach(file => {
                if (file.type.startsWith('image/')) {
                    if (file.size > 5 * 1024 * 1024) {
                        showMessage('Ukuran foto terlalu besar! Maksimal 5MB per foto.', 'error');
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        selectedPhotos.push({
                            file: file,
                            dataUrl: e.target.result,
                            name: file.name
                        });
                        updatePhotoPreview();
                    };
                    reader.readAsDataURL(file);
                } else {
                    showMessage('Format file tidak didukung! Gunakan JPG atau PNG.', 'error');
                }
            });
            
            // Reset input
            event.target.value = '';
        }

        // Update photo preview
        function updatePhotoPreview() {
            const preview = document.getElementById('photoPreview');
            preview.innerHTML = '';
            
            selectedPhotos.forEach((photo, index) => {
                const photoItem = document.createElement('div');
                photoItem.className = 'photo-item';
                photoItem.innerHTML = `
                    <img src="${photo.dataUrl}" alt="${photo.name}">
                    <button class="photo-remove" onclick="removePhoto(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                preview.appendChild(photoItem);
            });
        }

        // Remove photo
        function removePhoto(index) {
            selectedPhotos.splice(index, 1);
            updatePhotoPreview();
        }

        // Show click indicator animation
        function showClickIndicator(point) {
            const indicator = document.createElement('div');
            indicator.className = 'click-indicator';
            indicator.style.left = point.x + 'px';
            indicator.style.top = point.y + 'px';
            
            const mapContainer = document.getElementById('map');
            mapContainer.appendChild(indicator);
            
            // Remove indicator after animation
            setTimeout(() => {
                if (indicator.parentNode) {
                    indicator.parentNode.removeChild(indicator);
                }
            }, 1000);
        }

        // Update location indicator
        function updateLocationIndicator(lat, lng) {
            const indicator = document.getElementById('locationSelectedIndicator');
            const textElement = document.getElementById('selectedLocationText');
            
            textElement.textContent = `Lokasi terpilih: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            indicator.classList.add('show');
        }

        // Clear location indicator
        function clearLocationIndicator() {
            const indicator = document.getElementById('locationSelectedIndicator');
            const textElement = document.getElementById('selectedLocationText');
            
            textElement.textContent = 'Lokasi belum dipilih';
            indicator.classList.remove('show');
        }

        // Clear temporary point marker
        function clearTempPointMarker() {
            if (tempPointMarker) {
                map.removeLayer(tempPointMarker);
                tempPointMarker = null;
            }
        }

        // Highlight selected marker
        function highlightMarker(marker) {
            // Clear previous selection
            clearAllSelections();
            
            // Add selection class
            const markerElement = marker.getElement();
            if (markerElement) {
                markerElement.classList.add('selected-marker');
                selectedMarker = marker;
            }
        }

        // Highlight selected line
        function highlightLine(line) {
            // Clear previous selection
            clearAllSelections();
            
            // Add selection style
            line.setStyle({
                weight: 6,
                className: 'selected-line'
            });
            selectedLine = line;
        }

        // Highlight selected polygon
        function highlightPolygon(polygon) {
            // Clear previous selection
            clearAllSelections();
            
            // Add selection style
            polygon.setStyle({
                weight: 5,
                className: 'selected-polygon'
            });
            selectedPolygon = polygon;
        }

        // Clear all selections
        function clearAllSelections() {
            // Clear marker selection
            if (selectedMarker) {
                const markerElement = selectedMarker.getElement();
                if (markerElement) {
                    markerElement.classList.remove('selected-marker');
                }
                selectedMarker = null;
            }
            
            // Clear line selection
            if (selectedLine) {
                // Reset to original style based on category
                const originalData = lineData.find(line => {
                    const bounds1 = selectedLine.getBounds();
                    const bounds2 = L.latLngBounds(line.coordinates);
                    return bounds1.equals(bounds2);
                });
                
                if (originalData) {
                    const categoryColors = {
                        'Jalan': '#ef4444',
                        'Sungai': '#3b82f6',
                        'Jalur Transportasi': '#10b981',
                        'Batas Wilayah': '#f59e0b',
                        'Lainnya': '#6b7280'
                    };
                    const color = categoryColors[originalData.category] || '#6b7280';
                    selectedLine.setStyle({
                        color: color,
                        weight: 4,
                        opacity: 0.8,
                        className: ''
                    });
                }
                selectedLine = null;
            }
            
            // Clear polygon selection
            if (selectedPolygon) {
                // Reset to original style based on category
                const originalData = polygonData.find(polygon => {
                    const bounds1 = selectedPolygon.getBounds();
                    const bounds2 = L.latLngBounds(polygon.coordinates);
                    return bounds1.equals(bounds2);
                });
                
                if (originalData) {
                    const categoryColors = {
                        'Wilayah Administrasi': '#ef4444',
                        'Kawasan Industri': '#3b82f6',
                        'Kawasan Pemukiman': '#10b981',
                        'Taman/Hutan': '#22c55e',
                        'Danau/Waduk': '#06b6d4',
                        'Lainnya': '#6b7280'
                    };
                    const color = categoryColors[originalData.category] || '#6b7280';
                    selectedPolygon.setStyle({
                        color: color,
                        weight: 3,
                        opacity: 0.8,
                        fillColor: color,
                        fillOpacity: 0.3,
                        className: ''
                    });
                }
                selectedPolygon = null;
            }
        }

        // Switch tabs
        function switchTab(tabName) {
            // Remove active class from all tabs and panels
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
            
            // Add active class to selected tab and panel
            event.target.classList.add('active');
            document.getElementById(tabName + '-panel').classList.add('active');
            
            // Clear all temporary elements and selections when switching tabs
            clearAllSelections();
            clearTempPointMarker();
            clearLocationIndicator();
            
            if (tabName === 'dashboard') {
                updateDashboard();
            } else if (tabName === 'line') {
                // Clear any existing temp line when switching to line tab
                clearTempLine();
                clearTempPolygon();
                currentLineCoords = [];
                updateCoordinatesList();
            } else if (tabName === 'polygon') {
                // Clear any existing temp elements when switching to polygon tab
                clearTempLine();
                clearTempPolygon();
                clearTempCircle();
                currentPolygonCoords = [];
                updatePolygonCoordinatesList();
                // Reset to free drawing mode
                setPolygonMode('free');
            } else if (tabName === 'input') {
                // Clear temp elements when switching to input tab
                clearTempLine();
                clearTempPolygon();
                // Reset selected coordinates
                window.selectedLat = null;
                window.selectedLng = null;
            }
        }

        // Switch data tabs
        function switchDataTab(tabName) {
            // Remove active class from data tabs
            document.querySelectorAll('#dashboard-panel .tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.data-tab-panel').forEach(panel => panel.style.display = 'none');
            
            // Add active class to selected tab and show panel
            event.target.classList.add('active');
            document.getElementById(tabName + '-data').style.display = 'block';
        }

        // Calculate line length using Haversine formula
        function calculateLineLength(coordinates) {
            if (coordinates.length < 2) return 0;
            
            let totalLength = 0;
            for (let i = 0; i < coordinates.length - 1; i++) {
                const lat1 = coordinates[i][0] * Math.PI / 180;
                const lon1 = coordinates[i][1] * Math.PI / 180;
                const lat2 = coordinates[i + 1][0] * Math.PI / 180;
                const lon2 = coordinates[i + 1][1] * Math.PI / 180;
                
                const dlat = lat2 - lat1;
                const dlon = lon2 - lon1;
                
                const a = Math.sin(dlat/2) * Math.sin(dlat/2) +
                         Math.cos(lat1) * Math.cos(lat2) *
                         Math.sin(dlon/2) * Math.sin(dlon/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                const distance = 6371000 * c; // Earth radius in meters
                
                totalLength += distance;
            }
            
            return totalLength;
        }

        // Format distance for display
        function formatDistance(meters) {
            if (meters < 1000) {
                return `${meters.toFixed(2)} meter`;
            } else if (meters < 1000000) {
                return `${(meters / 1000).toFixed(2)} km`;
            } else {
                return `${(meters / 1000000).toFixed(2)} Mm`;
            }
        }

        // Line coordinate functions
        function updateCoordinatesList() {
            const coordinatesList = document.getElementById('coordinatesList');
            coordinatesList.innerHTML = '';
            
            currentLineCoords.forEach((coord, index) => {
                const coordItem = document.createElement('div');
                coordItem.className = 'coordinate-item';
                coordItem.innerHTML = `
                    <span>Titik ${index + 1}: ${coord[0].toFixed(6)}, ${coord[1].toFixed(6)}</span>
                    <button class="coordinate-remove" onclick="removeCoordinate(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                coordinatesList.appendChild(coordItem);
            });
            
            // Update line length display
            const length = calculateLineLength(currentLineCoords);
            document.getElementById('lineLength').innerHTML = `
                <i class="fas fa-ruler"></i> Panjang: ${formatDistance(length)}
            `;
        }

        function removeCoordinate(index) {
            currentLineCoords.splice(index, 1);
            updateCoordinatesList();
            updateTempLine();
        }

        function clearLineCoordinates() {
            currentLineCoords = [];
            updateCoordinatesList();
            clearTempLine();
        }

        function undoLastPoint() {
            if (currentLineCoords.length > 0) {
                currentLineCoords.pop();
                updateCoordinatesList();
                updateTempLine();
            }
        }

        function updateTempLine() {
            clearTempLine();
            
            if (currentLineCoords.length >= 2) {
                tempLine = L.polyline(currentLineCoords, {
                    color: '#2563eb',
                    weight: 3,
                    opacity: 0.7,
                    className: 'temp-line'
                }).addTo(map);
            }
        }

        function clearTempLine() {
            if (tempLine) {
                map.removeLayer(tempLine);
                tempLine = null;
            }
        }

        // Calculate polygon area using Shoelace formula
        function calculatePolygonArea(coordinates) {
            if (coordinates.length < 3) return 0;
            
            // Convert to projected coordinates (approximate)
            const projectedCoords = coordinates.map(coord => {
                const lat = coord[0] * Math.PI / 180;
                const lng = coord[1] * Math.PI / 180;
                const x = 6371000 * lng * Math.cos(lat);
                const y = 6371000 * lat;
                return [x, y];
            });
            
            let area = 0;
            const n = projectedCoords.length;
            
            for (let i = 0; i < n; i++) {
                const j = (i + 1) % n;
                area += projectedCoords[i][0] * projectedCoords[j][1];
                area -= projectedCoords[j][0] * projectedCoords[i][1];
            }
            
            return Math.abs(area) / 2;
        }

        // Format area for display
        function formatArea(squareMeters) {
            if (squareMeters < 10000) {
                return `${squareMeters.toFixed(2)} mÂ²`;
            } else if (squareMeters < 1000000) {
                return `${(squareMeters / 10000).toFixed(2)} hektar`;
            } else {
                return `${(squareMeters / 1000000).toFixed(2)} kmÂ²`;
            }
        }

        // Polygon coordinate functions
        function updatePolygonCoordinatesList() {
            const coordinatesList = document.getElementById('polygonCoordinatesList');
            coordinatesList.innerHTML = '';
            
            currentPolygonCoords.forEach((coord, index) => {
                const coordItem = document.createElement('div');
                coordItem.className = 'coordinate-item';
                coordItem.innerHTML = `
                    <span>Titik ${index + 1}: ${coord[0].toFixed(6)}, ${coord[1].toFixed(6)}</span>
                    <button class="coordinate-remove" onclick="removePolygonCoordinate(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                coordinatesList.appendChild(coordItem);
            });
            
            // Update polygon area display
            const area = calculatePolygonArea(currentPolygonCoords);
            document.getElementById('polygonArea').innerHTML = `
                <i class="fas fa-vector-square"></i> Luas Area: ${formatArea(area)}
            `;
        }

        function removePolygonCoordinate(index) {
            currentPolygonCoords.splice(index, 1);
            updatePolygonCoordinatesList();
            updateTempPolygon();
        }

        function clearPolygonCoordinates() {
            currentPolygonCoords = [];
            updatePolygonCoordinatesList();
            clearTempPolygon();
            clearTempCircle();
            isDrawingSquare = false;
            squareStartPoint = null;
        }

        function undoLastPolygonPoint() {
            if (currentPolygonCoords.length > 0) {
                currentPolygonCoords.pop();
                updatePolygonCoordinatesList();
                updateTempPolygon();
            }
        }

        function updateTempPolygon() {
            clearTempPolygon();
            
            if (currentPolygonCoords.length >= 3) {
                tempPolygon = L.polygon(currentPolygonCoords, {
                    color: '#2563eb',
                    weight: 3,
                    opacity: 0.7,
                    fillColor: '#2563eb',
                    fillOpacity: 0.2,
                    className: 'temp-polygon'
                }).addTo(map);
            }
        }

        function clearTempPolygon() {
            if (tempPolygon) {
                map.removeLayer(tempPolygon);
                tempPolygon = null;
            }
        }

        // Add line form handler
        document.getElementById('lineForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('lineName').value;
            const category = document.getElementById('lineCategory').value;
            const description = document.getElementById('lineDescription').value;
            
            if (currentLineCoords.length < 2) {
                showLineMessage('Minimal 2 titik diperlukan untuk membuat line!', 'error');
                return;
            }
            
            const newLine = {
                name: name,
                category: category,
                description: description,
                coordinates: [...currentLineCoords],
                length: calculateLineLength(currentLineCoords)
            };
            
            // Add custom field values
            lineColumns.forEach(column => {
                const fieldValue = document.getElementById(column.id).value;
                newLine[column.id] = fieldValue;
            });
            
            addLineToMap(newLine);
            lineData.push(newLine);
            
            // Reset form and coordinates
            this.reset();
            currentLineCoords = [];
            updateCoordinatesList();
            clearTempLine();
            updateLineCustomFields();
            
            showLineMessage('Line berhasil ditambahkan!', 'success');
            updateDashboard();
        });

        // Add polygon form handler
        document.getElementById('polygonForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('polygonName').value;
            const category = document.getElementById('polygonCategory').value;
            const description = document.getElementById('polygonDescription').value;
            
            if (currentPolygonCoords.length < 3) {
                showPolygonMessage('Minimal 3 titik diperlukan untuk membuat polygon!', 'error');
                return;
            }
            
            const newPolygon = {
                name: name,
                category: category,
                description: description,
                coordinates: [...currentPolygonCoords],
                area: calculatePolygonArea(currentPolygonCoords)
            };
            
            // Add custom field values
            polygonColumns.forEach(column => {
                const fieldValue = document.getElementById(column.id).value;
                newPolygon[column.id] = fieldValue;
            });
            
            addPolygonToMap(newPolygon);
            polygonData.push(newPolygon);
            
            // Reset form and coordinates
            this.reset();
            currentPolygonCoords = [];
            updatePolygonCoordinatesList();
            clearTempPolygon();
            updatePolygonCustomFields();
            
            showPolygonMessage('Polygon berhasil ditambahkan!', 'success');
            updateDashboard();
        });

        // Add manual location
        document.getElementById('manualForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('locationName').value;
            const category = document.getElementById('category').value;
            const description = document.getElementById('description').value;
            
            // Check if coordinates are selected from map
            if (!window.selectedLat || !window.selectedLng) {
                showMessage('Silakan klik pada peta untuk menentukan lokasi!', 'error');
                return;
            }
            
            const lat = window.selectedLat;
            const lng = window.selectedLng;
            
            const newLocation = {
                name: name,
                lat: lat,
                lng: lng,
                category: category,
                description: description,
                photos: selectedPhotos.map(photo => ({
                    dataUrl: photo.dataUrl,
                    name: photo.name
                }))
            };
            
            // Add custom field values
            customColumns.forEach(column => {
                const fieldValue = document.getElementById(column.id).value;
                newLocation[column.id] = fieldValue;
            });
            
            addLocationToMap(newLocation);
            locationData.push(newLocation);
            
            // Reset form and photos
            this.reset();
            selectedPhotos = [];
            updatePhotoPreview();
            updateCustomFields();
            
            // Reset selected coordinates and clear temp marker
            window.selectedLat = null;
            window.selectedLng = null;
            clearTempPointMarker();
            clearLocationIndicator();
            
            showMessage('Lokasi berhasil ditambahkan!', 'success');
            updateDashboard();
        });

        // Update line custom fields in form
        function updateLineCustomFields() {
            const customFieldsContainer = document.getElementById('lineCustomFields');
            customFieldsContainer.innerHTML = '';
            
            lineColumns.forEach(column => {
                const fieldGroup = document.createElement('div');
                fieldGroup.className = 'form-group';
                
                let inputHtml = '';
                
                switch (column.type) {
                    case 'text':
                        inputHtml = `<input type="text" id="${column.id}">`;
                        break;
                    case 'number':
                        inputHtml = `<input type="number" id="${column.id}">`;
                        break;
                    case 'date':
                        inputHtml = `<input type="date" id="${column.id}">`;
                        break;
                    case 'select':
                        inputHtml = `<select id="${column.id}">
                            <option value="">Pilih...</option>
                            ${column.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                        </select>`;
                        break;
                }
                
                fieldGroup.innerHTML = `
                    <label>${column.name}</label>
                    ${inputHtml}
                `;
                customFieldsContainer.appendChild(fieldGroup);
            });
        }

        // Update custom fields in form
        function updateCustomFields() {
            const customFieldsContainer = document.getElementById('customFields');
            customFieldsContainer.innerHTML = '';
            
            customColumns.forEach(column => {
                const fieldGroup = document.createElement('div');
                fieldGroup.className = 'form-group';
                
                let inputHtml = '';
                
                switch (column.type) {
                    case 'text':
                        inputHtml = `<input type="text" id="${column.id}">`;
                        break;
                    case 'number':
                        inputHtml = `<input type="number" id="${column.id}">`;
                        break;
                    case 'date':
                        inputHtml = `<input type="date" id="${column.id}">`;
                        break;
                    case 'select':
                        inputHtml = `<select id="${column.id}">
                            <option value="">Pilih...</option>
                            ${column.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                        </select>`;
                        break;
                }
                
                fieldGroup.innerHTML = `
                    <label>${column.name}</label>
                    ${inputHtml}
                `;
                customFieldsContainer.appendChild(fieldGroup);
            });
        }

        // Add line to map
        function addLineToMap(lineData) {
            const categoryColors = {
                'Jalan': '#ef4444',
                'Sungai': '#3b82f6',
                'Jalur Transportasi': '#10b981',
                'Batas Wilayah': '#f59e0b',
                'Lainnya': '#6b7280'
            };

            const color = categoryColors[lineData.category] || '#6b7280';
            
            const line = L.polyline(lineData.coordinates, {
                color: color,
                weight: 4,
                opacity: 0.8
            }).addTo(map);
            
            // Add click event to highlight line
            line.on('click', function() {
                highlightLine(line);
            });
            
            let customFieldsHtml = '';
            lineColumns.forEach(column => {
                const value = lineData[column.id];
                if (value) {
                    customFieldsHtml += `<strong>${column.name}:</strong> ${value}<br>`;
                }
            });
            
            const popupContent = `
                <div class="custom-popup">
                    <div class="popup-title">${lineData.name}</div>
                    <div class="popup-content">
                        <strong>Kategori:</strong> ${lineData.category}<br>
                        <strong>Panjang:</strong> ${formatDistance(lineData.length)}<br>
                        <strong>Jumlah Titik:</strong> ${lineData.coordinates.length}<br>
                        ${lineData.description ? `<strong>Deskripsi:</strong> ${lineData.description}<br>` : ''}
                        ${customFieldsHtml}
                        <span class="popup-category">${lineData.category}</span>
                    </div>
                </div>
            `;
            
            line.bindPopup(popupContent);
            lines.push(line);
        }

        // Add polygon to map
        function addPolygonToMap(polygonData) {
            const categoryColors = {
                'Wilayah Administrasi': '#ef4444',
                'Kawasan Industri': '#3b82f6',
                'Kawasan Pemukiman': '#10b981',
                'Taman/Hutan': '#22c55e',
                'Danau/Waduk': '#06b6d4',
                'Lainnya': '#6b7280'
            };

            const color = categoryColors[polygonData.category] || '#6b7280';
            
            const polygon = L.polygon(polygonData.coordinates, {
                color: color,
                weight: 3,
                opacity: 0.8,
                fillColor: color,
                fillOpacity: 0.3
            }).addTo(map);
            
            // Add click event to highlight polygon
            polygon.on('click', function() {
                highlightPolygon(polygon);
            });
            
            let customFieldsHtml = '';
            polygonColumns.forEach(column => {
                const value = polygonData[column.id];
                if (value) {
                    customFieldsHtml += `<strong>${column.name}:</strong> ${value}<br>`;
                }
            });
            
            const popupContent = `
                <div class="custom-popup">
                    <div class="popup-title">${polygonData.name}</div>
                    <div class="popup-content">
                        <strong>Kategori:</strong> ${polygonData.category}<br>
                        <strong>Luas Area:</strong> ${formatArea(polygonData.area)}<br>
                        <strong>Jumlah Titik:</strong> ${polygonData.coordinates.length}<br>
                        ${polygonData.description ? `<strong>Deskripsi:</strong> ${polygonData.description}<br>` : ''}
                        ${customFieldsHtml}
                        <span class="popup-category">${polygonData.category}</span>
                    </div>
                </div>
            `;
            
            polygon.bindPopup(popupContent);
            polygons.push(polygon);
        }

        // Add location to map
        function addLocationToMap(location) {
            const categoryColors = {
                'Restoran': '#ef4444',
                'Hotel': '#3b82f6',
                'Wisata': '#10b981',
                'Rumah Sakit': '#f59e0b',
                'Sekolah': '#8b5cf6',
                'Lainnya': '#6b7280'
            };

            const categoryIcons = {
                'Restoran': 'utensils',
                'Hotel': 'bed',
                'Wisata': 'camera',
                'Rumah Sakit': 'hospital',
                'Sekolah': 'graduation-cap',
                'Lainnya': 'map-marker'
            };

            const color = categoryColors[location.category] || '#6b7280';
            const icon = categoryIcons[location.category] || 'map-marker';
            
            const customIcon = L.divIcon({
                html: `<div style="background-color: ${color}; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 3px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.3);"><i class="fas fa-${icon}" style="color: white; font-size: 12px;"></i></div>`,
                className: 'custom-marker',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
            
            const marker = L.marker([location.lat, location.lng], { icon: customIcon }).addTo(map);
            
            // Add click event to highlight marker
            marker.on('click', function() {
                highlightMarker(marker);
            });
            
            // Generate popup content based on settings
            let popupContentHtml = '';
            
            if (popupSettings.showName) {
                popupContentHtml += `<div class="popup-title">${location.name}</div>`;
            }
            
            popupContentHtml += '<div class="popup-content">';
            
            if (popupSettings.showCategory) {
                popupContentHtml += `<span class="popup-category">${location.category}</span><br>`;
            }
            
            if (popupSettings.showDescription && location.description) {
                popupContentHtml += `<strong>Deskripsi:</strong> ${location.description}<br>`;
            }
            
            if (popupSettings.showCoordinates) {
                popupContentHtml += `<strong>Koordinat:</strong> ${location.lat.toFixed(6)}, ${location.lng.toFixed(6)}<br>`;
            }
            
            // Add custom fields based on settings
            customColumns.forEach(column => {
                if (popupSettings.customFields.includes(column.id) && location[column.id]) {
                    popupContentHtml += `<strong>${column.name}:</strong> ${location[column.id]}<br>`;
                }
            });
            
            // Add photos if enabled
            if (popupSettings.showPhotos && location.photos && location.photos.length > 0) {
                popupContentHtml += '<div class="popup-photos">';
                location.photos.forEach((photo, index) => {
                    popupContentHtml += `
                        <div class="popup-photo" onclick="openPhotoModal('${photo.dataUrl}')">
                            <img src="${photo.dataUrl}" alt="${photo.name}">
                        </div>
                    `;
                });
                popupContentHtml += '</div>';
            }
            
            popupContentHtml += '</div>';
            
            const popupContent = `<div class="custom-popup">${popupContentHtml}</div>`;
            
            marker.bindPopup(popupContent);
            markers.push(marker);
        }

        // Handle file upload
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.size > 5 * 1024 * 1024) {
                showMessage('File terlalu besar! Maksimal 5MB.', 'error');
                return;
            }
            
            document.getElementById('loading').style.display = 'block';
            
            const reader = new FileReader();
            
            if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                reader.onload = function(e) {
                    try {
                        processExcelData(e.target.result);
                        showMessage(`File Excel ${file.name} berhasil diimport!`, 'success');
                    } catch (error) {
                        showMessage('Error membaca file Excel: ' + error.message, 'error');
                    } finally {
                        document.getElementById('loading').style.display = 'none';
                    }
                };
                reader.readAsArrayBuffer(file);
            } else {
                reader.onload = function(e) {
                    try {
                        if (file.name.endsWith('.json')) {
                            const data = JSON.parse(e.target.result);
                            processJSONData(data);
                        } else if (file.name.endsWith('.kml')) {
                            processKMLData(e.target.result);
                        }
                        showMessage(`File ${file.name} berhasil diimport!`, 'success');
                    } catch (error) {
                        showMessage('Error membaca file: ' + error.message, 'error');
                    } finally {
                        document.getElementById('loading').style.display = 'none';
                    }
                };
                reader.readAsText(file);
            }
        }

        // Process Excel data
        function processExcelData(arrayBuffer) {
            const workbook = XLSX.read(arrayBuffer, { type: 'array' });
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet);
            
            let importedCount = 0;
            
            jsonData.forEach(row => {
                // Look for latitude and longitude columns (case insensitive)
                const keys = Object.keys(row);
                let latKey = keys.find(key => 
                    key.toLowerCase().includes('lat') || 
                    key.toLowerCase().includes('latitude') ||
                    key.toLowerCase() === 'y'
                );
                let lngKey = keys.find(key => 
                    key.toLowerCase().includes('lng') || 
                    key.toLowerCase().includes('lon') || 
                    key.toLowerCase().includes('longitude') ||
                    key.toLowerCase() === 'x'
                );
                
                if (latKey && lngKey) {
                    const lat = parseFloat(row[latKey]);
                    const lng = parseFloat(row[lngKey]);
                    
                    if (!isNaN(lat) && !isNaN(lng)) {
                        // Look for name column
                        let nameKey = keys.find(key => 
                            key.toLowerCase().includes('name') || 
                            key.toLowerCase().includes('nama') ||
                            key.toLowerCase().includes('title') ||
                            key.toLowerCase().includes('judul')
                        );
                        
                        // Look for category column
                        let categoryKey = keys.find(key => 
                            key.toLowerCase().includes('category') || 
                            key.toLowerCase().includes('kategori') ||
                            key.toLowerCase().includes('type') ||
                            key.toLowerCase().includes('tipe')
                        );
                        
                        // Look for description column
                        let descKey = keys.find(key => 
                            key.toLowerCase().includes('desc') || 
                            key.toLowerCase().includes('description') ||
                            key.toLowerCase().includes('keterangan') ||
                            key.toLowerCase().includes('detail')
                        );
                        
                        const location = {
                            name: row[nameKey] || `Lokasi ${importedCount + 1}`,
                            lat: lat,
                            lng: lng,
                            category: row[categoryKey] || 'Lainnya',
                            description: row[descKey] || '',
                            photos: []
                        };
                        
                        // Add other columns as custom fields
                        keys.forEach(key => {
                            if (key !== latKey && key !== lngKey && key !== nameKey && 
                                key !== categoryKey && key !== descKey && row[key]) {
                                // Create custom column if it doesn't exist
                                let customColumn = customColumns.find(col => col.name === key);
                                if (!customColumn) {
                                    customColumn = {
                                        name: key,
                                        type: 'text',
                                        id: 'custom_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9)
                                    };
                                    customColumns.push(customColumn);
                                }
                                location[customColumn.id] = row[key].toString();
                            }
                        });
                        
                        addLocationToMap(location);
                        locationData.push(location);
                        importedCount++;
                    }
                }
            });
            
            if (importedCount > 0) {
                updateDashboard();
                updateTableHeaders();
                updateCustomFields();
                showMessage(`${importedCount} lokasi berhasil diimport dari Excel!`, 'success');
            } else {
                showMessage('Tidak ditemukan data dengan kolom latitude dan longitude yang valid!', 'error');
            }
        }

        // Process JSON data
        function processJSONData(data) {
            if (Array.isArray(data)) {
                data.forEach(item => {
                    if (item.lat && item.lng && item.name) {
                        const location = {
                            name: item.name || 'Unnamed',
                            lat: parseFloat(item.lat),
                            lng: parseFloat(item.lng),
                            category: item.category || 'Lainnya',
                            description: item.description || '',
                            photos: item.photos || []
                        };
                        addLocationToMap(location);
                        locationData.push(location);
                    }
                });
            } else if (data.features) {
                // GeoJSON format
                data.features.forEach(feature => {
                    if (feature.geometry && feature.geometry.coordinates) {
                        const coords = feature.geometry.coordinates;
                        const location = {
                            name: feature.properties?.name || 'Unnamed',
                            lat: coords[1],
                            lng: coords[0],
                            category: feature.properties?.category || 'Lainnya',
                            description: feature.properties?.description || '',
                            photos: feature.properties?.photos || []
                        };
                        addLocationToMap(location);
                        locationData.push(location);
                    }
                });
            }
            updateDashboard();
        }

        // Process KML data (simplified)
        function processKMLData(kmlText) {
            const parser = new DOMParser();
            const kmlDoc = parser.parseFromString(kmlText, 'text/xml');
            const placemarks = kmlDoc.getElementsByTagName('Placemark');
            
            for (let placemark of placemarks) {
                const name = placemark.getElementsByTagName('name')[0]?.textContent || 'Unnamed';
                const description = placemark.getElementsByTagName('description')[0]?.textContent || '';
                
                // Check for Point geometry
                const point = placemark.getElementsByTagName('Point')[0];
                if (point) {
                    const coordinates = point.getElementsByTagName('coordinates')[0]?.textContent;
                    if (coordinates) {
                        const coords = coordinates.trim().split(',');
                        if (coords.length >= 2) {
                            const location = {
                                name: name,
                                lat: parseFloat(coords[1]),
                                lng: parseFloat(coords[0]),
                                category: 'Lainnya',
                                description: description,
                                photos: []
                            };
                            addLocationToMap(location);
                            locationData.push(location);
                        }
                    }
                }
                
                // Check for LineString geometry
                const lineString = placemark.getElementsByTagName('LineString')[0];
                if (lineString) {
                    const coordinates = lineString.getElementsByTagName('coordinates')[0]?.textContent;
                    if (coordinates) {
                        const coordPairs = coordinates.trim().split(/\s+/);
                        const lineCoords = [];
                        
                        coordPairs.forEach(pair => {
                            const coords = pair.split(',');
                            if (coords.length >= 2) {
                                lineCoords.push([parseFloat(coords[1]), parseFloat(coords[0])]);
                            }
                        });
                        
                        if (lineCoords.length >= 2) {
                            const lineDataItem = {
                                name: name,
                                category: 'Lainnya',
                                description: description,
                                coordinates: lineCoords
                            };
                            addLineToMap(lineDataItem);
                            lineData.push(lineDataItem);
                        }
                    }
                }
            }
            updateDashboard();
        }

        // Search location
        function searchLocation() {
            const query = document.getElementById('searchInput').value;
            if (!query) return;
            
            // Simple search in existing data
            const found = locationData.find(loc => 
                loc.name.toLowerCase().includes(query.toLowerCase())
            );
            
            if (found) {
                map.setView([found.lat, found.lng], 15);
                // Find and open popup for the marker
                markers.forEach(marker => {
                    if (marker.getLatLng().lat === found.lat && marker.getLatLng().lng === found.lng) {
                        marker.openPopup();
                    }
                });
                showMessage(`Lokasi "${found.name}" ditemukan!`, 'success');
            } else {
                // Try geocoding with Nominatim (OpenStreetMap)
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.length > 0) {
                            const result = data[0];
                            map.setView([parseFloat(result.lat), parseFloat(result.lon)], 13);
                            showMessage(`Lokasi "${result.display_name}" ditemukan!`, 'success');
                        } else {
                            showMessage('Lokasi tidak ditemukan!', 'error');
                        }
                    })
                    .catch(error => {
                        showMessage('Error pencarian: ' + error.message, 'error');
                    });
            }
        }

        // Update dashboard
        function updateDashboard() {
            // Update statistics
            document.getElementById('totalLocations').textContent = locationData.length;
            document.getElementById('totalLines').textContent = lineData.length;
            document.getElementById('totalPolygons').textContent = polygonData.length;
            
            const categories = [...new Set(locationData.map(loc => loc.category))];
            document.getElementById('totalCategories').textContent = categories.length;
            
            // Update category filter
            const categoryFilter = document.getElementById('categoryFilter');
            categoryFilter.innerHTML = '<option value="">Semua Kategori</option>';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categoryFilter.appendChild(option);
            });
            
            // Update chart
            updateChart();
            
            // Update tables
            updateTable();
            updateLineTable();
            updatePolygonTable();
        }

        // Update chart
        function updateChart() {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            
            if (chart) {
                chart.destroy();
            }
            
            const categoryCount = {};
            locationData.forEach(loc => {
                categoryCount[loc.category] = (categoryCount[loc.category] || 0) + 1;
            });
            
            const labels = Object.keys(categoryCount);
            const data = Object.values(categoryCount);
            const colors = ['#ef4444', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#6b7280'];
            
            chart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 10,
                                font: {
                                    size: 11
                                }
                            }
                        }
                    }
                }
            });
        }

        // Update line table
        function updateLineTable() {
            const tbody = document.getElementById('lineTableBody');
            tbody.innerHTML = '';
            
            lineData.forEach((line, index) => {
                const row = tbody.insertRow();
                
                // Basic columns
                row.insertCell(0).textContent = line.name;
                row.insertCell(1).textContent = line.category;
                row.insertCell(2).textContent = formatDistance(line.length || 0);
                row.insertCell(3).textContent = line.coordinates.length;
                
                // Custom columns
                lineColumns.forEach(column => {
                    const cell = row.insertCell(-1);
                    cell.textContent = line[column.id] || '';
                });
                
                // Action buttons
                const actionCell = row.insertCell(-1);
                actionCell.innerHTML = `
                    <div class="action-buttons">
                        <button class="action-btn edit" onclick="editLine(${index})" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn delete" onclick="deleteLine(${index})" title="Hapus">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                // Make row clickable (except action buttons)
                const cells = row.querySelectorAll('td:not(:last-child)');
                cells.forEach(cell => {
                    cell.style.cursor = 'pointer';
                    cell.onclick = () => {
                        // Zoom to line bounds
                        const bounds = L.latLngBounds(line.coordinates);
                        map.fitBounds(bounds);
                        
                        // Highlight and open popup for the line
                        lines.forEach((mapLine, mapIndex) => {
                            if (mapIndex === index) {
                                highlightLine(mapLine);
                                mapLine.openPopup();
                            }
                        });
                    };
                });
            });
        }

        // Update polygon table
        function updatePolygonTable() {
            const tbody = document.getElementById('polygonTableBody');
            tbody.innerHTML = '';
            
            polygonData.forEach((polygon, index) => {
                const row = tbody.insertRow();
                
                // Basic columns
                row.insertCell(0).textContent = polygon.name;
                row.insertCell(1).textContent = polygon.category;
                row.insertCell(2).textContent = formatArea(polygon.area || 0);
                row.insertCell(3).textContent = polygon.coordinates.length;
                
                // Custom columns
                polygonColumns.forEach(column => {
                    const cell = row.insertCell(-1);
                    cell.textContent = polygon[column.id] || '';
                });
                
                // Action buttons
                const actionCell = row.insertCell(-1);
                actionCell.innerHTML = `
                    <div class="action-buttons">
                        <button class="action-btn edit" onclick="editPolygon(${index})" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn delete" onclick="deletePolygon(${index})" title="Hapus">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                // Make row clickable (except action buttons)
                const cells = row.querySelectorAll('td:not(:last-child)');
                cells.forEach(cell => {
                    cell.style.cursor = 'pointer';
                    cell.onclick = () => {
                        // Zoom to polygon bounds
                        const bounds = L.latLngBounds(polygon.coordinates);
                        map.fitBounds(bounds);
                        
                        // Highlight and open popup for the polygon
                        polygons.forEach((mapPolygon, mapIndex) => {
                            if (mapIndex === index) {
                                highlightPolygon(mapPolygon);
                                mapPolygon.openPopup();
                            }
                        });
                    };
                });
            });
        }

        // Update table
        function updateTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            const filteredData = getFilteredData();
            
            filteredData.forEach((location, filteredIndex) => {
                const originalIndex = locationData.indexOf(location);
                const row = tbody.insertRow();
                
                // Basic columns
                row.insertCell(0).textContent = location.name;
                row.insertCell(1).textContent = location.category;
                
                // Custom columns
                customColumns.forEach(column => {
                    const cell = row.insertCell(-1);
                    cell.textContent = location[column.id] || '';
                });
                
                // Action buttons
                const actionCell = row.insertCell(-1);
                actionCell.innerHTML = `
                    <div class="action-buttons">
                        <button class="action-btn edit" onclick="editLocation(${originalIndex})" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn delete" onclick="deleteLocation(${originalIndex})" title="Hapus">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                // Make row clickable (except action buttons)
                const cells = row.querySelectorAll('td:not(:last-child)');
                cells.forEach(cell => {
                    cell.style.cursor = 'pointer';
                    cell.onclick = () => {
                        map.setView([location.lat, location.lng], 15);
                        markers.forEach(marker => {
                            if (marker.getLatLng().lat === location.lat && marker.getLatLng().lng === location.lng) {
                                highlightMarker(marker);
                                marker.openPopup();
                            }
                        });
                    };
                });
            });
        }

        // Get filtered data
        function getFilteredData() {
            const categoryFilter = document.getElementById('categoryFilter').value;
            
            if (!categoryFilter) {
                return locationData;
            }
            
            return locationData.filter(loc => loc.category === categoryFilter);
        }

        // Filter data
        function filterData() {
            updateTable();
            
            // Hide/show markers based on filter
            const categoryFilter = document.getElementById('categoryFilter').value;
            
            markers.forEach((marker, index) => {
                const location = locationData[index];
                if (!categoryFilter || location.category === categoryFilter) {
                    marker.addTo(map);
                } else {
                    map.removeLayer(marker);
                }
            });
        }

        // Sort table
        let sortDirection = {};
        function sortTable(columnIndex) {
            const table = document.getElementById('dataTable');
            const tbody = table.getElementsByTagName('tbody')[0];
            const rows = Array.from(tbody.getElementsByTagName('tr'));
            
            const isAscending = sortDirection[columnIndex] !== 'asc';
            sortDirection[columnIndex] = isAscending ? 'asc' : 'desc';
            
            rows.sort((a, b) => {
                const aValue = a.cells[columnIndex].textContent;
                const bValue = b.cells[columnIndex].textContent;
                
                // All columns are now text-based since we removed lat/lng
                return isAscending ? 
                    aValue.localeCompare(bValue) : 
                    bValue.localeCompare(aValue);
            });
            
            // Clear tbody and append sorted rows
            tbody.innerHTML = '';
            rows.forEach(row => tbody.appendChild(row));
        }

        // Polygon mode functions
        function setPolygonMode(mode) {
            polygonMode = mode;
            
            // Update button styles
            document.getElementById('freeDrawBtn').className = 'btn btn-secondary';
            document.getElementById('squareDrawBtn').className = 'btn btn-secondary';
            document.getElementById('circleDrawBtn').className = 'btn btn-secondary';
            
            // Highlight active button
            if (mode === 'free') {
                document.getElementById('freeDrawBtn').className = 'btn';
                document.getElementById('freeDrawBtn').style.background = '#2563eb';
            } else if (mode === 'square') {
                document.getElementById('squareDrawBtn').className = 'btn';
                document.getElementById('squareDrawBtn').style.background = '#2563eb';
            } else if (mode === 'circle') {
                document.getElementById('circleDrawBtn').className = 'btn';
                document.getElementById('circleDrawBtn').style.background = '#2563eb';
            }
            
            // Show/hide radius control for circle mode
            const radiusControl = document.getElementById('circleRadiusControl');
            if (mode === 'circle') {
                radiusControl.style.display = 'block';
            } else {
                radiusControl.style.display = 'none';
            }
            
            // Update instructions
            updatePolygonInstructions();
            
            // Clear current drawing
            clearPolygonCoordinates();
            clearTempCircle();
            isDrawingSquare = false;
            squareStartPoint = null;
        }

        function updatePolygonInstructions() {
            const instructionText = document.getElementById('polygonInstructionText');
            const instructionLabel = document.getElementById('polygonInstructionLabel');
            
            switch(polygonMode) {
                case 'free':
                    instructionLabel.textContent = 'Koordinat Polygon (klik pada peta untuk menambah titik)';
                    instructionText.innerHTML = 'Klik pada peta untuk menambah titik polygon. Minimal 3 titik diperlukan. Polygon akan otomatis tertutup.';
                    break;
                case 'square':
                    instructionLabel.textContent = 'Gambar Persegi (klik 2 titik diagonal)';
                    instructionText.innerHTML = 'Klik pada peta untuk menentukan sudut pertama, kemudian klik lagi untuk sudut diagonal yang berlawanan.';
                    break;
                case 'circle':
                    instructionLabel.textContent = 'Gambar Lingkaran (klik pusat lingkaran)';
                    instructionText.innerHTML = 'Atur radius menggunakan slider, kemudian klik pada peta untuk menentukan pusat lingkaran.';
                    break;
            }
        }

        function handlePolygonClick(e) {
            switch(polygonMode) {
                case 'free':
                    // Add point to polygon coordinates
                    currentPolygonCoords.push([e.latlng.lat, e.latlng.lng]);
                    updatePolygonCoordinatesList();
                    updateTempPolygon();
                    break;
                case 'square':
                    handleSquareClick(e);
                    break;
                case 'circle':
                    handleCircleClick(e);
                    break;
            }
        }

        function handleSquareClick(e) {
            if (!isDrawingSquare) {
                // First click - set start point
                squareStartPoint = [e.latlng.lat, e.latlng.lng];
                isDrawingSquare = true;
                showMessage('Klik titik diagonal yang berlawanan untuk menyelesaikan persegi', 'success');
            } else {
                // Second click - create square
                const endPoint = [e.latlng.lat, e.latlng.lng];
                createSquarePolygon(squareStartPoint, endPoint);
                isDrawingSquare = false;
                squareStartPoint = null;
            }
        }

        function handleCircleClick(e) {
            const centerPoint = [e.latlng.lat, e.latlng.lng];
            createCirclePolygon(centerPoint, circleRadius);
        }

        function createSquarePolygon(startPoint, endPoint) {
            // Create square coordinates from diagonal points
            const lat1 = startPoint[0];
            const lng1 = startPoint[1];
            const lat2 = endPoint[0];
            const lng2 = endPoint[1];
            
            // Create square coordinates (clockwise)
            const squareCoords = [
                [lat1, lng1], // Top-left
                [lat1, lng2], // Top-right
                [lat2, lng2], // Bottom-right
                [lat2, lng1]  // Bottom-left
            ];
            
            currentPolygonCoords = squareCoords;
            updatePolygonCoordinatesList();
            updateTempPolygon();
            
            showMessage('Persegi berhasil dibuat!', 'success');
        }

        function createCirclePolygon(centerPoint, radiusMeters) {
            const centerLat = centerPoint[0];
            const centerLng = centerPoint[1];
            
            // Convert radius from meters to degrees (approximate)
            const radiusLat = radiusMeters / 111320; // 1 degree lat â 111.32 km
            const radiusLng = radiusMeters / (111320 * Math.cos(centerLat * Math.PI / 180));
            
            // Create circle with 32 points
            const circleCoords = [];
            const points = 32;
            
            for (let i = 0; i < points; i++) {
                const angle = (i * 2 * Math.PI) / points;
                const lat = centerLat + radiusLat * Math.cos(angle);
                const lng = centerLng + radiusLng * Math.sin(angle);
                circleCoords.push([lat, lng]);
            }
            
            currentPolygonCoords = circleCoords;
            updatePolygonCoordinatesList();
            updateTempPolygon();
            
            showMessage(`Lingkaran dengan radius ${radiusMeters}m berhasil dibuat!`, 'success');
        }

        function updateCircleRadius() {
            const slider = document.getElementById('circleRadiusSlider');
            const input = document.getElementById('circleRadiusInput');
            circleRadius = parseInt(slider.value);
            input.value = circleRadius;
        }

        function updateCircleRadiusFromInput() {
            const slider = document.getElementById('circleRadiusSlider');
            const input = document.getElementById('circleRadiusInput');
            circleRadius = parseInt(input.value);
            slider.value = circleRadius;
        }

        function clearTempCircle() {
            if (tempCircle) {
                map.removeLayer(tempCircle);
                tempCircle = null;
            }
        }

        // Clear all data
        function clearAllData() {
            if (confirm('Apakah Anda yakin ingin menghapus semua data?')) {
                locationData = [];
                markers.forEach(marker => map.removeLayer(marker));
                markers = [];
                updateDashboard();
                showMessage('Semua data berhasil dihapus!', 'success');
            }
        }

        // Open photo modal
        function openPhotoModal(photoUrl) {
            const modal = document.getElementById('photoModal');
            const modalPhoto = document.getElementById('modalPhoto');
            modalPhoto.src = photoUrl;
            modal.style.display = 'flex';
        }

        // Close photo modal
        function closePhotoModal() {
            const modal = document.getElementById('photoModal');
            modal.style.display = 'none';
        }

        // Show message
        function showMessage(message, type) {
            const successEl = document.getElementById('successMessage');
            const errorEl = document.getElementById('errorMessage');
            
            // Hide both messages first
            successEl.style.display = 'none';
            errorEl.style.display = 'none';
            
            if (type === 'success') {
                successEl.textContent = message;
                successEl.style.display = 'block';
                setTimeout(() => successEl.style.display = 'none', 3000);
            } else {
                errorEl.textContent = message;
                errorEl.style.display = 'block';
                setTimeout(() => errorEl.style.display = 'none', 5000);
            }
        }

        // Column management functions
        function openColumnManager() {
            document.getElementById('columnModal').style.display = 'flex';
            updateColumnsList();
        }

        function closeColumnModal() {
            document.getElementById('columnModal').style.display = 'none';
        }

        function addCustomColumn() {
            const name = document.getElementById('newColumnName').value.trim();
            const type = document.getElementById('newColumnType').value;
            
            if (!name) {
                showMessage('Nama kolom tidak boleh kosong!', 'error');
                return;
            }
            
            if (customColumns.find(col => col.name === name)) {
                showMessage('Nama kolom sudah ada!', 'error');
                return;
            }
            
            const newColumn = {
                name: name,
                type: type,
                id: 'custom_' + Date.now()
            };
            
            if (type === 'select') {
                const options = document.getElementById('selectOptionsList').value.split(',').map(opt => opt.trim()).filter(opt => opt);
                if (options.length === 0) {
                    showMessage('Opsi pilihan tidak boleh kosong!', 'error');
                    return;
                }
                newColumn.options = options;
            }
            
            customColumns.push(newColumn);
            
            // Add column to existing data
            locationData.forEach(location => {
                location[newColumn.id] = '';
            });
            
            document.getElementById('newColumnName').value = '';
            document.getElementById('selectOptionsList').value = '';
            
            updateColumnsList();
            updateTable();
            updateTableHeaders();
            updateCustomFields();
            showMessage('Kolom berhasil ditambahkan!', 'success');
        }

        function deleteCustomColumn(columnId) {
            if (confirm('Apakah Anda yakin ingin menghapus kolom ini?')) {
                customColumns = customColumns.filter(col => col.id !== columnId);
                
                // Remove column from existing data
                locationData.forEach(location => {
                    delete location[columnId];
                });
                
                updateColumnsList();
                updateTable();
                updateTableHeaders();
                updateCustomFields();
                showMessage('Kolom berhasil dihapus!', 'success');
            }
        }

        function updateColumnsList() {
            const columnsList = document.getElementById('columnsList');
            columnsList.innerHTML = '';
            
            customColumns.forEach(column => {
                const columnItem = document.createElement('div');
                columnItem.className = 'column-item';
                columnItem.innerHTML = `
                    <div class="column-info">
                        <div class="column-name">${column.name}</div>
                        <div class="column-type">Tipe: ${column.type}</div>
                    </div>
                    <button class="delete-column-btn" onclick="deleteCustomColumn('${column.id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                columnsList.appendChild(columnItem);
            });
            
            // Update popup fields list
            updatePopupFieldsList();
        }

        function updatePopupFieldsList() {
            const popupFieldsList = document.getElementById('popupFieldsList');
            popupFieldsList.innerHTML = '';
            
            // Default fields
            const defaultFields = [
                { id: 'name', name: 'Nama Lokasi', checked: popupSettings.showName },
                { id: 'category', name: 'Kategori', checked: popupSettings.showCategory },
                { id: 'description', name: 'Deskripsi', checked: popupSettings.showDescription },
                { id: 'coordinates', name: 'Koordinat', checked: popupSettings.showCoordinates },
                { id: 'photos', name: 'Foto', checked: popupSettings.showPhotos }
            ];
            
            defaultFields.forEach(field => {
                const fieldItem = document.createElement('div');
                fieldItem.className = 'popup-field-item';
                fieldItem.innerHTML = `
                    <input type="checkbox" id="popup_${field.id}" ${field.checked ? 'checked' : ''} 
                           onchange="updatePopupSetting('${field.id}', this.checked)">
                    <label for="popup_${field.id}">${field.name}</label>
                `;
                popupFieldsList.appendChild(fieldItem);
            });
            
            // Custom fields
            if (customColumns.length > 0) {
                const separator = document.createElement('div');
                separator.innerHTML = '<hr style="margin: 10px 0;"><strong>Kolom Custom:</strong>';
                popupFieldsList.appendChild(separator);
                
                customColumns.forEach(column => {
                    const fieldItem = document.createElement('div');
                    fieldItem.className = 'popup-field-item';
                    const isChecked = popupSettings.customFields.includes(column.id);
                    fieldItem.innerHTML = `
                        <input type="checkbox" id="popup_${column.id}" ${isChecked ? 'checked' : ''} 
                               onchange="updateCustomFieldSetting('${column.id}', this.checked)">
                        <label for="popup_${column.id}">${column.name}</label>
                    `;
                    popupFieldsList.appendChild(fieldItem);
                });
            }
        }

        function updatePopupSetting(field, checked) {
            switch(field) {
                case 'name':
                    popupSettings.showName = checked;
                    break;
                case 'category':
                    popupSettings.showCategory = checked;
                    break;
                case 'description':
                    popupSettings.showDescription = checked;
                    break;
                case 'coordinates':
                    popupSettings.showCoordinates = checked;
                    break;
                case 'photos':
                    popupSettings.showPhotos = checked;
                    break;
            }
            
            // Refresh all markers with new popup content
            refreshAllPopups();
        }

        function updateCustomFieldSetting(fieldId, checked) {
            if (checked) {
                if (!popupSettings.customFields.includes(fieldId)) {
                    popupSettings.customFields.push(fieldId);
                }
            } else {
                popupSettings.customFields = popupSettings.customFields.filter(id => id !== fieldId);
            }
            
            // Refresh all markers with new popup content
            refreshAllPopups();
        }

        function refreshAllPopups() {
            // Remove all existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            // Re-add all markers with updated popup content
            locationData.forEach(location => {
                addLocationToMap(location);
            });
        }

        function updateTableHeaders() {
            const tableHead = document.getElementById('tableHead');
            const headerRow = tableHead.querySelector('tr');
            
            // Remove existing custom headers
            const existingHeaders = headerRow.querySelectorAll('.custom-header');
            existingHeaders.forEach(header => header.remove());
            
            // Add custom headers before action column
            const actionHeader = headerRow.querySelector('th:last-child');
            customColumns.forEach((column, index) => {
                const th = document.createElement('th');
                th.className = 'custom-header';
                th.innerHTML = `${column.name} <i class="fas fa-sort"></i>`;
                th.onclick = () => sortTable(2 + index);
                headerRow.insertBefore(th, actionHeader);
            });
        }

        // Edit location functions
        function editLocation(index) {
            editingIndex = index;
            const location = locationData[index];
            
            document.getElementById('editLocationName').value = location.name;
            document.getElementById('editLatitude').value = location.lat;
            document.getElementById('editLongitude').value = location.lng;
            document.getElementById('editCategory').value = location.category;
            document.getElementById('editDescription').value = location.description || '';
            
            // Load custom fields
            const customFieldsContainer = document.getElementById('editCustomFields');
            customFieldsContainer.innerHTML = '';
            
            customColumns.forEach(column => {
                const fieldGroup = document.createElement('div');
                fieldGroup.className = 'form-group';
                
                let inputHtml = '';
                const value = location[column.id] || '';
                
                switch (column.type) {
                    case 'text':
                        inputHtml = `<input type="text" id="edit_${column.id}" value="${value}">`;
                        break;
                    case 'number':
                        inputHtml = `<input type="number" id="edit_${column.id}" value="${value}">`;
                        break;
                    case 'date':
                        inputHtml = `<input type="date" id="edit_${column.id}" value="${value}">`;
                        break;
                    case 'select':
                        inputHtml = `<select id="edit_${column.id}">
                            <option value="">Pilih...</option>
                            ${column.options.map(opt => `<option value="${opt}" ${value === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                        </select>`;
                        break;
                }
                
                fieldGroup.innerHTML = `
                    <label>${column.name}</label>
                    ${inputHtml}
                `;
                customFieldsContainer.appendChild(fieldGroup);
            });
            
            // Load photos
            editPhotos = location.photos ? [...location.photos] : [];
            updateEditPhotoPreview();
            
            document.getElementById('editModal').style.display = 'flex';
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            editingIndex = -1;
            editPhotos = [];
        }

        function deleteLocation(index) {
            if (confirm('Apakah Anda yakin ingin menghapus lokasi ini?')) {
                // Remove marker from map
                map.removeLayer(markers[index]);
                
                // Remove from arrays
                locationData.splice(index, 1);
                markers.splice(index, 1);
                
                updateDashboard();
                showMessage('Lokasi berhasil dihapus!', 'success');
            }
        }

        function handleEditPhotoUpload(event) {
            const files = Array.from(event.target.files);
            
            if (editPhotos.length + files.length > 2) {
                showMessage('Maksimal hanya 2 foto yang diperbolehkan!', 'error');
                return;
            }
            
            files.forEach(file => {
                if (file.type.startsWith('image/')) {
                    if (file.size > 5 * 1024 * 1024) {
                        showMessage('Ukuran foto terlalu besar! Maksimal 5MB per foto.', 'error');
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        editPhotos.push({
                            dataUrl: e.target.result,
                            name: file.name
                        });
                        updateEditPhotoPreview();
                    };
                    reader.readAsDataURL(file);
                } else {
                    showMessage('Format file tidak didukung! Gunakan JPG atau PNG.', 'error');
                }
            });
            
            event.target.value = '';
        }

        function updateEditPhotoPreview() {
            const preview = document.getElementById('editPhotoPreview');
            preview.innerHTML = '';
            
            editPhotos.forEach((photo, index) => {
                const photoItem = document.createElement('div');
                photoItem.className = 'photo-item';
                photoItem.innerHTML = `
                    <img src="${photo.dataUrl}" alt="${photo.name}">
                    <button class="photo-remove" onclick="removeEditPhoto(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                preview.appendChild(photoItem);
            });
        }

        function removeEditPhoto(index) {
            editPhotos.splice(index, 1);
            updateEditPhotoPreview();
        }

        // Handle edit form submission
        document.getElementById('editForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (editingIndex === -1) return;
            
            const name = document.getElementById('editLocationName').value;
            const lat = parseFloat(document.getElementById('editLatitude').value);
            const lng = parseFloat(document.getElementById('editLongitude').value);
            const category = document.getElementById('editCategory').value;
            const description = document.getElementById('editDescription').value;
            
            if (isNaN(lat) || isNaN(lng)) {
                showMessage('Koordinat tidak valid!', 'error');
                return;
            }
            
            // Update location data
            const updatedLocation = {
                name: name,
                lat: lat,
                lng: lng,
                category: category,
                description: description,
                photos: editPhotos.map(photo => ({
                    dataUrl: photo.dataUrl,
                    name: photo.name
                }))
            };
            
            // Add custom field values
            customColumns.forEach(column => {
                const fieldValue = document.getElementById(`edit_${column.id}`).value;
                updatedLocation[column.id] = fieldValue;
            });
            
            // Remove old marker
            map.removeLayer(markers[editingIndex]);
            
            // Update data
            locationData[editingIndex] = updatedLocation;
            
            // Add new marker
            addLocationToMap(updatedLocation);
            markers[editingIndex] = markers[markers.length - 1];
            markers.pop();
            
            closeEditModal();
            updateDashboard();
            showMessage('Lokasi berhasil diperbarui!', 'success');
        });

        // Show/hide select options based on column type
        document.getElementById('newColumnType').addEventListener('change', function() {
            const selectOptions = document.getElementById('selectOptions');
            if (this.value === 'select') {
                selectOptions.style.display = 'block';
            } else {
                selectOptions.style.display = 'none';
            }
        });

        // Change basemap function
        function changeBasemap() {
            const selectedBasemap = document.getElementById('basemapSelector').value;
            
            // Remove current basemap
            if (currentBasemap) {
                map.removeLayer(currentBasemap);
            }
            
            // Add new basemap
            currentBasemap = basemaps[selectedBasemap];
            currentBasemap.addTo(map);
        }

        // Export to KMZ function (with photos)
        function exportToKMZ() {
            // Check if there's any data to export
            const hasPoints = locationData.length > 0;
            const hasLines = lineData.length > 0;
            const hasPolygons = polygonData.length > 0;
            
            if (!hasPoints && !hasLines && !hasPolygons) {
                showMessage('Tidak ada data untuk diekspor!', 'error');
                return;
            }
            
            // Check if there are photos in points
            const hasPhotos = locationData.some(location => location.photos && location.photos.length > 0);
            
            if (!hasPhotos) {
                // If no photos, export as KML
                exportToKML();
                return;
            }
            
            const zip = new JSZip();
            const imagesFolder = zip.folder("images");
            
            // Generate KML content with image references
            let kmlContent = generateKMLContent(true); // true for KMZ mode
            
            // Add images to zip (only from points that have photos)
            locationData.forEach((location, locIndex) => {
                if (location.photos && location.photos.length > 0) {
                    location.photos.forEach((photo, photoIndex) => {
                        const imageFileName = `image_${locIndex}_${photoIndex}.jpg`;
                        // Convert base64 to blob
                        const base64Data = photo.dataUrl.split(',')[1];
                        imagesFolder.file(imageFileName, base64Data, {base64: true});
                    });
                }
            });
            
            // Add KML file to zip
            zip.file("doc.kml", kmlContent);
            
            // Generate and download KMZ
            zip.generateAsync({type:"blob"}).then(function(content) {
                const url = URL.createObjectURL(content);
                const a = document.createElement('a');
                a.href = url;
                a.download = `webgis_export_${new Date().toISOString().split('T')[0]}.kmz`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                // Show success message with data summary
                const exportSummary = [];
                if (hasPoints) exportSummary.push(`${locationData.length} point`);
                if (hasLines) exportSummary.push(`${lineData.length} line`);
                if (hasPolygons) exportSummary.push(`${polygonData.length} polygon`);
                
                showMessage(`File KMZ berhasil diunduh dengan ${exportSummary.join(', ')}!`, 'success');
            });
        }

        // Generate KML content
        function generateKMLContent(isKMZ = false) {
            // Check what data types exist
            const hasPoints = locationData.length > 0;
            const hasLines = lineData.length > 0;
            const hasPolygons = polygonData.length > 0;
            
            let kmlContent = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
    <Document>
        <name>WebGIS Export</name>
        <description>Data ekspor dari WebGIS Interaktif</description>
`;

            // Add styles only for data types that exist
            if (hasPoints) {
                kmlContent += `
        <!-- Point Styles -->
        <Style id="restoran">
            <IconStyle>
                <color>ff4444ef</color>
                <Icon><href>http://maps.google.com/mapfiles/kml/pushpin/red-pushpin.png</href></Icon>
            </IconStyle>
        </Style>
        <Style id="hotel">
            <IconStyle>
                <color>fff63b3b</color>
                <Icon><href>http://maps.google.com/mapfiles/kml/pushpin/blue-pushpin.png</href></Icon>
            </IconStyle>
        </Style>
        <Style id="wisata">
            <IconStyle>
                <color>ff81b910</color>
                <Icon><href>http://maps.google.com/mapfiles/kml/pushpin/grn-pushpin.png</href></Icon>
            </IconStyle>
        </Style>
        <Style id="rumah_sakit">
            <IconStyle>
                <color>ff0b9ef5</color>
                <Icon><href>http://maps.google.com/mapfiles/kml/pushpin/ylw-pushpin.png</href></Icon>
            </IconStyle>
        </Style>
        <Style id="sekolah">
            <IconStyle>
                <color>fff65c8b</color>
                <Icon><href>http://maps.google.com/mapfiles/kml/pushpin/purple-pushpin.png</href></Icon>
            </IconStyle>
        </Style>
        <Style id="lainnya">
            <IconStyle>
                <color>ff807280</color>
                <Icon><href>http://maps.google.com/mapfiles/kml/pushpin/wht-pushpin.png</href></Icon>
            </IconStyle>
        </Style>
`;
            }

            if (hasLines) {
                kmlContent += `
        <!-- Line Styles -->
        <Style id="jalan">
            <LineStyle>
                <color>ff4444ef</color>
                <width>4</width>
            </LineStyle>
        </Style>
        <Style id="sungai">
            <LineStyle>
                <color>fff63b3b</color>
                <width>4</width>
            </LineStyle>
        </Style>
        <Style id="jalur_transportasi">
            <LineStyle>
                <color>ff81b910</color>
                <width>4</width>
            </LineStyle>
        </Style>
        <Style id="batas_wilayah">
            <LineStyle>
                <color>ff0b9ef5</color>
                <width>4</width>
            </LineStyle>
        </Style>
        <Style id="line_lainnya">
            <LineStyle>
                <color>ff807280</color>
                <width>4</width>
            </LineStyle>
        </Style>
`;
            }

            if (hasPolygons) {
                kmlContent += `
        <!-- Polygon Styles -->
        <Style id="wilayah_administrasi">
            <LineStyle>
                <color>ff4444ef</color>
                <width>3</width>
            </LineStyle>
            <PolyStyle>
                <color>4d4444ef</color>
            </PolyStyle>
        </Style>
        <Style id="kawasan_industri">
            <LineStyle>
                <color>fff63b3b</color>
                <width>3</width>
            </LineStyle>
            <PolyStyle>
                <color>4df63b3b</color>
            </PolyStyle>
        </Style>
        <Style id="kawasan_pemukiman">
            <LineStyle>
                <color>ff81b910</color>
                <width>3</width>
            </LineStyle>
            <PolyStyle>
                <color>4d81b910</color>
            </PolyStyle>
        </Style>
        <Style id="taman_hutan">
            <LineStyle>
                <color>ff55c522</color>
                <width>3</width>
            </LineStyle>
            <PolyStyle>
                <color>4d55c522</color>
            </PolyStyle>
        </Style>
        <Style id="danau_waduk">
            <LineStyle>
                <color>ffd4b606</color>
                <width>3</width>
            </LineStyle>
            <PolyStyle>
                <color>4dd4b606</color>
            </PolyStyle>
        </Style>
        <Style id="polygon_lainnya">
            <LineStyle>
                <color>ff807280</color>
                <width>3</width>
            </LineStyle>
            <PolyStyle>
                <color>4d807280</color>
            </PolyStyle>
        </Style>
`;
            }

            // Add Points folder only if there are points
            if (hasPoints) {
                kmlContent += `
        <!-- Points Folder -->
        <Folder>
            <name>Points</name>
            <description>Data titik lokasi</description>
`;

                // Add points
                locationData.forEach((location, locIndex) => {
                    const styleId = location.category.toLowerCase().replace(/\s+/g, '_');
                    let customFieldsData = '';
                    
                    customColumns.forEach(column => {
                        const value = location[column.id];
                        if (value) {
                            customFieldsData += `${column.name}: ${value}\n`;
                        }
                    });
                    
                    let photosHtml = '';
                    if (isKMZ && location.photos && location.photos.length > 0) {
                        photosHtml = '<br/>Foto:<br/>';
                        location.photos.forEach((photo, photoIndex) => {
                            const imageFileName = `images/image_${locIndex}_${photoIndex}.jpg`;
                            photosHtml += `<img src="${imageFileName}" width="200"><br/>`;
                        });
                    }
                    
                    kmlContent += `
            <Placemark>
                <name>${escapeXml(location.name)}</name>
                <description><![CDATA[
                    Kategori: ${location.category}<br/>
                    ${location.description ? `Deskripsi: ${location.description}<br/>` : ''}
                    ${customFieldsData ? `${customFieldsData.replace(/\n/g, '<br/>')}` : ''}
                    Koordinat: ${location.lat.toFixed(6)}, ${location.lng.toFixed(6)}
                    ${photosHtml}
                ]]></description>
                <styleUrl>#${styleId}</styleUrl>
                <Point>
                    <coordinates>${location.lng},${location.lat},0</coordinates>
                </Point>
            </Placemark>`;
                });
                
                kmlContent += `
        </Folder>
`;
            }

            // Add Lines folder only if there are lines
            if (hasLines) {
                kmlContent += `
        <!-- Lines Folder -->
        <Folder>
            <name>Lines</name>
            <description>Data garis/jalur</description>
`;

                // Add lines
                lineData.forEach(line => {
                    const styleId = line.category.toLowerCase().replace(/\s+/g, '_');
                    let customFieldsData = '';
                    
                    lineColumns.forEach(column => {
                        const value = line[column.id];
                        if (value) {
                            customFieldsData += `${column.name}: ${value}\n`;
                        }
                    });
                    
                    const coordinates = line.coordinates.map(coord => `${coord[1]},${coord[0]},0`).join(' ');
                    
                    kmlContent += `
            <Placemark>
                <name>${escapeXml(line.name)}</name>
                <description><![CDATA[
                    Kategori: ${line.category}<br/>
                    ${line.description ? `Deskripsi: ${line.description}<br/>` : ''}
                    ${customFieldsData ? `${customFieldsData.replace(/\n/g, '<br/>')}` : ''}
                    Panjang: ${formatDistance(line.length || 0)}<br/>
                    Jumlah Titik: ${line.coordinates.length}
                ]]></description>
                <styleUrl>#${styleId === 'lainnya' ? 'line_lainnya' : styleId}</styleUrl>
                <LineString>
                    <tessellate>1</tessellate>
                    <coordinates>${coordinates}</coordinates>
                </LineString>
            </Placemark>`;
                });
                
                kmlContent += `
        </Folder>
`;
            }

            // Add Polygons folder only if there are polygons
            if (hasPolygons) {
                kmlContent += `
        <!-- Polygons Folder -->
        <Folder>
            <name>Polygons</name>
            <description>Data area/polygon</description>
`;

                // Add polygons
                polygonData.forEach(polygon => {
                    const styleId = polygon.category.toLowerCase().replace(/\s+/g, '_').replace(/\//g, '_');
                    let customFieldsData = '';
                    
                    polygonColumns.forEach(column => {
                        const value = polygon[column.id];
                        if (value) {
                            customFieldsData += `${column.name}: ${value}\n`;
                        }
                    });
                    
                    // Close the polygon by adding the first coordinate at the end
                    const coordinates = [...polygon.coordinates, polygon.coordinates[0]]
                        .map(coord => `${coord[1]},${coord[0]},0`).join(' ');
                    
                    kmlContent += `
            <Placemark>
                <name>${escapeXml(polygon.name)}</name>
                <description><![CDATA[
                    Kategori: ${polygon.category}<br/>
                    ${polygon.description ? `Deskripsi: ${polygon.description}<br/>` : ''}
                    ${customFieldsData ? `${customFieldsData.replace(/\n/g, '<br/>')}` : ''}
                    Luas Area: ${formatArea(polygon.area || 0)}<br/>
                    Jumlah Titik: ${polygon.coordinates.length}
                ]]></description>
                <styleUrl>#${styleId === 'lainnya' ? 'polygon_lainnya' : styleId}</styleUrl>
                <Polygon>
                    <tessellate>1</tessellate>
                    <outerBoundaryIs>
                        <LinearRing>
                            <coordinates>${coordinates}</coordinates>
                        </LinearRing>
                    </outerBoundaryIs>
                </Polygon>
            </Placemark>`;
                });
                
                kmlContent += `
        </Folder>
`;
            }
            
            kmlContent += `
    </Document>
</kml>`;

            return kmlContent;
        }

        // Export to KML function
        function exportToKML() {
            // Check if there's any data to export
            const hasPoints = locationData.length > 0;
            const hasLines = lineData.length > 0;
            const hasPolygons = polygonData.length > 0;
            
            if (!hasPoints && !hasLines && !hasPolygons) {
                showMessage('Tidak ada data untuk diekspor!', 'error');
                return;
            }
            
            const kmlContent = generateKMLContent(false);

            // Download KML file
            const blob = new Blob([kmlContent], { type: 'application/vnd.google-earth.kml+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `webgis_export_${new Date().toISOString().split('T')[0]}.kml`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // Show success message with data summary
            const exportSummary = [];
            if (hasPoints) exportSummary.push(`${locationData.length} point`);
            if (hasLines) exportSummary.push(`${lineData.length} line`);
            if (hasPolygons) exportSummary.push(`${polygonData.length} polygon`);
            
            showMessage(`File KML berhasil diunduh dengan ${exportSummary.join(', ')}!`, 'success');
        }

        // Helper function to escape XML characters
        function escapeXml(unsafe) {
            return unsafe.replace(/[<>&'"]/g, function (c) {
                switch (c) {
                    case '<': return '&lt;';
                    case '>': return '&gt;';
                    case '&': return '&amp;';
                    case '\'': return '&apos;';
                    case '"': return '&quot;';
                }
            });
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initMap();

            
            sampleData.forEach(location => {
                addLocationToMap(location);
                locationData.push(location);
            });
            
            updateDashboard();
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9706c83046bcb772',t:'MTc1NTQwODY1My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
